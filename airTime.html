<html>
<head>
<title>AirTime</title>
<link rel="stylesheet" type="text/css" href="//ajax.googleapis.com/ajax/libs/dojo/1.13.0/dojo/resources/dojo.css" />
<link rel="stylesheet" type="text/css" href="//ajax.googleapis.com/ajax/libs/dojo/1.13.0/dijit/themes/claro/claro.css" />
<link rel="stylesheet" type="text/css" href="airTime.css" />
<link rel="stylesheet" type="text/css" href="widgets/css/airTime.css" />
<link rel="stylesheet" type="text/css" href="css/font-awesome.min.css" />
</head>
<body class="claro">
<div id="menu">
Année : 
</div>
<section id="mainContent">
<div id="entityContainer"><div id="entity"></div></div>
<div id="subContent" data-dojo-type="dijit/layout/ContentPane">
<div id="addFormDiv"></div>
</div>
</section>
<script src="https://bitwiseshiftleft.github.io/sjcl/sjcl.js"></script>
<script>dojoConfig={ requestProvider: "dojo/request/xhr", packages: [
{ name: "dgrid", location: "//cdn.rawgit.com/SitePen/dgrid/v1.1.0"  },
{ name: "dstore", location: "//cdn.rawgit.com/SitePen/dstore/v1.1.1"},
{ name: "workTime", location: "/horaire/js/" },
{ name: "atPerson", location: "/horaire/js/" },
{ name: "airTime", location: "/horaire/widgets/"},
{ name: "artnum", location: "//artnum.ch/code/js/" } ] }</script>
<script src="//cdn.rawgit.com/alexei/sprintf.js/master/src/sprintf.js"></script>
<script src="//ajax.googleapis.com/ajax/libs/dojo/1.13.0/dojo/dojo.js" data-dojo-config="locale: 'fr-ch', async: true"></script>
<script type="text/javascript">

var HStore = null;
var CurrentYear = new Date(Date.now()).getFullYear();


function Round10(val) {
	return (Math.round(val * 10) / 10);	
}

function printDate(date) {
	return sprintf("%02d.%02d.%d", date.getDate(), date.getMonth() + 1, date.getFullYear());
}
function printWidgetHour(date) {
	return sprintf('T%02d:%02d', date.getUTCHours(), date.getUTCMinutes());	
}
function printWidgetDate(date) {
	return sprintf("%d-%02d-%02d", date.getFullYear(), date.getMonth() + 1, date.getDate());
}



var FragId = {
	set: function(id) {
		document.location = String(document.location).split('#')[0] + '#' + id;
	},
	get: function() {
		var x = String(document.location).split('#');
		if(x.length>0) {
			return x[x.length - 1];
		}

		return null; 
	}
};


require([
	/* dojo */
	"dojo/parser",
	"dojo/_base/declare",
	"dojo/_base/lang",
	"dojo/dom",
	"dojo/on",
	"dojo/dom-construct",
	"dojo/dom-form",
	"dojo/dom-attr",
	"dojo/store/Memory",
	"dojo/date",
	"dojo/date/stamp",
	"dojo/query",
	"dojo/when",
	"dojo/Deferred",

	/* dstore */
	"dstore/Rest",
	"dstore/Cache",
	"dstore/Trackable",
	"dstore/legacy/DstoreAdapter",

	/* dijit */
	"dijit/Menu",
	"dijit/MenuItem",
	"dijit/layout/StackContainer",
	"dijit/layout/TabContainer",
	"dijit/layout/ContentPane",
	"dijit/layout/AccordionContainer",
	"dijit/registry",
	"dijit/form/Form",
	"dijit/form/Button",
	"dijit/form/TextBox",
	"dijit/form/NumberTextBox",
	"dijit/form/CheckBox",
	"dijit/form/DateTextBox",
	"dijit/form/TimeTextBox",
	"dijit/form/FilteringSelect",
	"dijit/form/Textarea",
	"dijit/form/Select",
	"dijit/Tooltip",
	"dijit/Dialog",
	"dijit/InlineEditBox",

	/* Work time */
	"workTime/workTime",
	"atPerson/atPerson",
	"airTime/Person",
	"airTime/AddTime",
	"airTime/TimeEntry",
	"airTime/DayBox",
	"airTime/TimeSheet",


	"dojo/domReady!"
 ],
 function(
	djParser,
	djDeclare,
	djLang,
	djDom,
	djOn,
	djDomConstruct,
	djDomForm,
	djDomAttr,
	djMemory,
	djDate,
	djDateStamp,
	djQuery,
	djWhen,
	djDeferred,

	dsRest,
	dsCache,
	dsTrackable,
	dsAdapter,

	dtMenu,
	dtMenuItem,
	dtStackContainer,
	dtTabContainer,
	dtContentPane,
	dtAccordionContainer,
	dtRegistry,
	dtForm,
	dtButton,
	dtTextBox,
	dtNumberTextBox,
	dtCheckBox,
	dtDateTextBox,
	dtTimeTextBox,
	dtFilteringSelect,
	dtTextarea,
	dtSelect,
	dtTooltip,
	dtDialog,
	dtInlineEditBox,

	WT,
	atPerson,
	airTimePerson,
	airTimeAddTime,
	TimeEntry,
	DayBox,
	TimeSheet,
 ){

var dayBoxes = {}, lastAddedDay = new Object, worktimes = {};
var cachedRestStore = djDeclare([dsRest, dsTrackable]);
var timeStore = new cachedRestStore({target: '/horaire/Time'});
var conditionStore = new cachedRestStore({target: '/horaire/Condition'});
var entityStore = new cachedRestStore({target: '/horaire/Entity'});
var holidayStore = new cachedRestStore({target: '/horaire/Holiday'});
var validationStore = new cachedRestStore({target: '/horaire/Validation'});
var PERSON = new atPerson(entityStore);
HStore = holidayStore;
var reasonStore = new djMemory({data: [
			{name: 'Travail', id: 'work'},
			{name: 'Vacances', id: 'holiday'},
			{name: 'Armée / PC / Service civil', id: 'army'},
			{name: 'Maladie', id: 'health'},
			{name: 'Accident', id: 'accident'},
			{name: 'Cours', id: 'learning'},
			{name: 'Compensation heures', id: 'overtime'},
			{name: 'Temps partiel', id: 'parttime'}
		]});
var timeType = new djMemory({data: [
			{name: 'Horaire', id: 'time'},
			{name: 'Demi-journée', id: 'halfday'},
			{name: 'Jour entier', id: 'wholeday'}
		]});
var monthStore = new djMemory({data: [
			{ name: 'Janvier', id: 0 },
			{ name: 'Février', id: 1 },
			{ name: 'Mars', id: 2 },
			{ name: 'Avril', id: 3 },
			{ name: 'Mai', id: 4 },
			{ name: 'Juin', id: 5 },
			{ name: 'Juillet', id: 6 },
			{ name: 'Août', id: 7 },
			{ name: 'Septembre', id: 8 },
			{ name: 'Octobre', id: 9 },
			{ name: 'Novembre', id: 10 },
			{ name: 'Décembre', id: 11}
		]});

var yearStart = new Date(Date.UTC(CurrentYear, 0, 1));
var yearStop = new Date(Date.UTC(CurrentYear, 11, 31));
var Conditions = null;
var _first = null;
conditionStore.forEach(function(e){
	if(_first == null) { _first = e; }
	if(e.default == 1) {
		Conditions = e;
	};
});
if(Conditions == null) {
	Conditions = _first;	
}
var Entities = {};
/*** Start */


/* Functions */
var CDate = function (stamp) {
		var d = djDateStamp.fromISOString(stamp);
		return d;
}

var fullAddFormEx = function() {
	console.log('fullAddFormEx');
	targetId = FragId.get();
	if(targetId == null) { return; }
	console.log(targetId);
	dtRegistry.byId('formStackContainer').selectChild(dtRegistry.byId("wait"));

	var oTimeSheet = dtRegistry.byId("TimeSheetXX");
	if(oTimeSheet) {
		dtRegistry.remove("TimeSheetXX");
		oTimeSheet.destroy();
		if(oTimeSheet.workTime) { 
			oTimeSheet.workTime.destroy();
			oTimeSheet.workTime = null;	
		}
		oTimeSheet = null;
	}
	var pp = dtRegistry.byId("PersonPane");
	if(pp) {
		pp.destroy();	
	}
	var timeSheet =  new TimeSheet({ id: "TimeSheetXX", target: targetId })
   var Now = new Date()
   var PersonName = dtRegistry.byId(targetId) ? dtRegistry.byId(targetId).label : ''
   var Holidays = []
	holidayStore.forEach(function(e){
		Holidays.push(new Date(e.day + 'T12:00:00Z'));
	}).then(function() {
		if(timeSheet.workTime == null) {
			/* Create worktime */
			timeSheet.addWorktime(new WT(targetId, entityStore, timeStore, conditionStore, validationStore, { 'OfficialHolidays': Holidays, lookingAt: [ yearStart.toISOString(), djDate.add(yearStart, "year", 1).toISOString() ]}));
		}

		djOn(timeSheet, "change-month", function (event) {
			displayTimeSheetEx(event.get('target'));
		});

		timeSheet.doValidate = function (e, month, year) {
			if( ! e) {
				validationStore.filter({target: timeSheet.target, month: month, year: year}).forEach(function (entry) {
					validationStore.remove(entry.id);
				});
			} else {
			/* atValidation_id atValidation_target atValidation_month atValidation_year atValidation_vacations atValidation_worktime atValidation_todo */
				var until = new Date(year, month + 1, 0), entry = { target: timeSheet.get('target'),
					month: month, year: year, vacations: 0, worktime: 0, todo: 0, overtime: 0 };
					entry.vacations =  timeSheet.workTime.HolidayDoneDay({ From: yearStart, To: until });
					entry.worktime = timeSheet.workTime.MinutesDone({ From: yearStart, To: until });
					entry.todo = timeSheet.workTime.MinutesToDo({ From: yearStart, To: until });
					entry.overtime = timeSheet.workTime.OverTimeDone({ From: yearStart, To: until });

					validationStore.put(entry).then( function (ret) {
						timeSheet.workTime.loadValidation().then(function () { timeSheet.checkValidation(); });
					});
			}
		}

		document.title=PersonName + ' - Feuille Horaire' ;
		timeSheet.set('title', document.title);
		
		formStackContainer = dtRegistry.byId('formStackContainer');
			var PersonPane = new dtContentPane({id: 'PersonPane', title: PersonName});
			PersonPane.addChild(timeSheet);

			/* Actual time */
			var timeForm = djDomConstruct.create('DIV');

			djDomConstruct.place(timeForm, PersonPane.domNode);


			/* Add Form*/
			timeSheet.addForm("Ajout horaire", new airTimeAddTime({reasonStore: reasonStore, target: targetId, timeStore: timeStore,
				addCallback: djLang.hitch(this,
					function (entry){
					lastAddedDay[entry.target] = djDateStamp.fromISOString(entry.begin);
					displayTimeSheetEx(entry.target);
				}),
				failCallback: null
			}));

			/* Form for driving hours */
			var drHour = new Array();
			var div = djDomConstruct.create('DIV');
			var aDriveHour = djDomConstruct.create('A', {innerHTML: 'Voir liste des heures',
				id: 'seeDriveForm_' + targetId, class: 'seeHours'});
			djDomConstruct.place(aDriveHour, div);
			drHour.push(div);

			djOn(aDriveHour, "click", function(evt) {
				var workTime = timeSheet.workTime;
				var until = new Date(new Date().getFullYear(), parseInt(timeSheet.get('month')) + 1, 0);
				var from = new Date(new Date().getFullYear(), parseInt(timeSheet.get('month')), 0);
				var hourDialog = new dtDialog({ connectId: [ djDomAttr.get(evt.target, 'id')], title: "Heures de conduites" });
				timeStore.filter({ reason: 'driving', from: from.toISOString(), until: until.toISOString(), target: targetId}).forEach(function(entry){
					var start = CDate(entry.begin);
					var dmin = workTime.printTime(djDate.difference(start, CDate(entry.end), 'minute'));
					var day = sprintf("%02d.%02d.%d", start.getDate(), start.getMonth() + 1, start.getFullYear());
					var removeLink = djDomConstruct.create('A', {innerHTML: 'supprimer', 'data-airtime-id': entry.id});
					var span = djDomConstruct.create('span', {innerHTML: entry.id + ' - ' + day + ' - ' + dmin + ' - ' });
					djDomConstruct.place(removeLink, span, "last");
					djDomConstruct.place(span, hourDialog.domNode, "last");
					djDomConstruct.place(djDomConstruct.create('BR'), hourDialog.domNode, "last");
					djOn(removeLink, "click", function(evt){
						var id = djDomAttr.get(evt.target, 'data-airtime-id');
						if(confirm('Voulez-vous vraiment supprimer ' + id)) {
							timeStore.remove(id);
							hourDialog.destroy();
							displayTimeSheetEx(targetId);
						}
					});

				}).then(function(){
					hourDialog.startup();
					hourDialog.show();
				});
			});

			var addDriverForm = new dtForm({id: 'addDriverForm_' + targetId, class: 'addForm' });
			addDriverForm.set('data-airtime-target', targetId);
			djDomConstruct.place( djDomConstruct.create('LABEL', { innerHTML: 'Jour ', for: "begin_drivingday"}), addDriverForm.domNode, "last");
			new dtDateTextBox({name: "drivingday", id: 'driveDayWidget_' + targetId, targetconstraints: {datePattern: "dd.MM.yyyy" }, value: Now }).placeAt(addDriverForm, "last");
			new dtTextBox({name: "drivinghour"}).placeAt(addDriverForm, "last");
			new dtButton({value: "Ajouter", innerHTML: "Ajouter", type: 'submit'}).placeAt(addDriverForm, "last");

			addDriverForm.on("submit", function(e){
				e.preventDefault();
				if(addDriverForm.validate()) {
					var requestJson = {
						target: addDriverForm.get('data-airtime-target'),
						remark: null,
						type: 'duration',
						reason: 'driving',
						begin: '',
						end: ''
					};
						
					var vals = addDriverForm.getValues();
					requestJson.begin = new Date(vals.drivingday.toDateString() + ' 00:00:00 UTC');

					var hours = vals.drivinghour.split(new RegExp(/\.|:|,| /));
					if(hours.length == 1) {
						var _m = parseInt(hours[0].slice(-2));
						var _h = parseInt(hours[0].slice(0, -2));
						if(_m>59) { hours = false } else {
							_m += _h * 60;
							requestJson.end = djDate.add(requestJson.begin, "minute", _m);
							hours = true;	
						} 
								
					} else if(hours.length == 2 ) {
						var _h = parseInt(hours[0]);
						var _m = parseInt(hours[1]);
						if(_m>59) { hours = false } else {
							_m += _h * 60;
							requestJson.end = djDate.add(requestJson.begin, "minute", _m);
							hours = true;
						}
					} else {
						hours = false;
					}

					if(hours == false) {
						alert('Nombre d\'heures invalides');	
						return false;
					}
				
					timeStore.add(requestJson).then(function(res){
						var dayWidget = dtRegistry.byId('driveDayWidget_' + targetId);

						addDriverForm.reset();

						var day = djDate.add(requestJson.begin, "day", 1);
						if(day.getDay() == 0 || day.getDay() == 6) {
							day = djDate.add(day, "day", 1);
							if(day.getDay() == 0) {
								day = djDate.add(day, "day", 1);
							}	
						}

						while(timeSheet.workTime.isHoliday(day)) {
								day = djDate.add(day, "day", 1);
						}

						dayWidget.set("value", djDateStamp.toISOString(day, { selector: "date" }));	
						dayWidget.focus();

						displayTimeSheetEx(requestJson.target);
					});
				}
				
			});

			drHour.push(addDriverForm.domNode);
			timeSheet.addForm('Horaires', drHour);


			dtRegistry.byId('formStackContainer').addChild(PersonPane);
		
		displayTimeSheetEx(targetId).then(function () {
			dtRegistry.byId('formStackContainer').selectChild(dtRegistry.byId("PersonPane" ), true);
		});
	});
} 


var displayTimeSheetEx = function(targetId) {
	console.log('displayTimeSheetEx');
	var def = new djDeferred();
	var originDom = djDom.byId("PersonPane");
	var timeSheet = dtRegistry.byId("TimeSheetXX");

	timeSheet.workTime.load().then(function () {
		if(timeSheet.firstRun) {
			timeSheet.set('ToMonth', 
				timeSheet.workTime.lastRegistredDay != null ?
					timeSheet.workTime.lastRegistredDay[0].getMonth() : 0
				); 
		}
		/* Load Holidays */
		var Holidays = timeSheet.workTime.OfficialHolidays;

		var daysSheet = djDom.byId('sheet_'+targetId);
		if(daysSheet) {
			for(var i in dayBoxes[targetId]) {
				dayBoxes[targetId][i].destroyRecursive(false);
			};
			dayBoxes[targetId] = {};
		} else {
			daysSheet = djDomConstruct.create('DIV', {id: "sheet_" + targetId, class: "daysSheet", 'data-target-id': targetId});
			djDomConstruct.place(daysSheet, originDom, "last");
		}

		var startDay = new Date(CurrentYear, parseInt(timeSheet.get('month')), 1, 12);
		var stopDay = new Date(CurrentYear, parseInt(timeSheet.get('month')) + 1 , 0, 12);
		
		for(var day = startDay; djDate.compare(day, stopDay, "date") <= 0; day = djDate.add(day, "day", 1)) {

			timeSheet.workTime.isHoliday(day);
			var box = new DayBox({date: day, holiday: timeSheet.workTime.isHoliday(day)});
			timeSheet.addDay(box);
			if( ! dayBoxes[targetId]) {
				dayBoxes[targetId] = {};
			}
			dayBoxes[targetId][box.cssDay()] = box;
		}
		
		displayTargetTimeEx(targetId).then(function(){ def.resolve(); });
	});
	return def;
}

var placeTime = function(boxid, span) {
	var box = djDom.byId(boxid);
	var bigger = null;
	var timenode = djQuery("span[data-airtime-order]", box).forEach(function(node){
		if(parseInt(djDomAttr.get(span, 'data-airtime-order')) > parseInt(djDomAttr.get(node,'data-airtime-order'))) {
			bigger = node;
		}	
	});

	if(bigger) {
		djDomConstruct.place(span, bigger, 'after');
	} else {
		djDomConstruct.place(span, box.firstChild, "after");
	}
}

var displayTargetTimeEx = function(targetId) {
	console.log('displayTargetTimeEx');
	var def = new djDeferred();
	var workTime = null;
	var lastDay = null;
	var timeSheet = dtRegistry.byId("TimeSheetXX");
	
			var until = new Date(CurrentYear, parseInt(timeSheet.get('month')) + 1, 0);

			timeStore.filter({from: yearStart.toISOString(), until: until.toISOString(), target: targetId}).forEach(function(entry) {
				var start = CDate(entry.begin);
				var end = CDate(entry.end);

				var currentTimeEntry = new TimeEntry({jsonEntry: entry, reasonStore: reasonStore, dayDuration: timeSheet.workTime.GetWholeDay(start), timeStore: timeStore});

				currentTimeEntry.on("removed", function(event) {
					displayTimeSheetEx(event.target);
				});

				
				switch(entry.type) {
					case 'halfday':
						end = djDate.add(start, "minute", timeSheet.workTime.GetHalfDay(start));
						break;
					case 'wholeday':
						end = djDate.add(start, "minute", timeSheet.workTime.GetWholeDay(start));
						break;	
				}

				if(lastDay == null) {
					lastDay = end;
				} else {
					if(djDate.compare(end, lastDay, "date") > 0) {
						lastDay = end;
					}
				}

				if( (start.getTime() >= new Date(until.getFullYear(), until.getMonth(), 1)) && (start.getTime() <= new Date(until.getFullYear(), until.getMonth() + 1, 1)))   {
					if(entry.reason != 'driving') {

						var reason = reasonStore.get(entry.reason);
						var reasonTxt = reason.name;

						var node = null;
						var boxId = sprintf("daybox_%s_%s", targetId, currentTimeEntry.cssDay());
						timeSheet.addEntry(currentTimeEntry);

					} else if(entry.reason == 'driving') {

/*						var dmin = timeSheet.workTime.printTime(djDate.difference(start, end, 'minute'));
						var boxId = sprintf("daybox_%s_%02d_%02d_%d", targetId, start.getDate(), start.getMonth() + 1, start.getFullYear());*/
						var nBoxId = sprintf("%02d_%02d_%d", start.getDate(), start.getMonth() + 1, start.getFullYear());
/*						if(djDom.byId(boxId)) {
							var tdtSpan = djDomConstruct.create('SPAN', {class: 'totalDayTime', innerHTML: "C : " + dmin});
							djDomConstruct.place(tdtSpan, djDom.byId(boxId).firstChild, "after");
						}
*/
						if(dayBoxes[targetId][nBoxId]) {
							dayBoxes[targetId][nBoxId].set("drivedTime", djDate.difference(start, end, "minute"));
						}
					}
				}
			}).then(function () {
				var workedTime =	timeSheet.workTime.MinutesDone({
					From: yearStart,
					To: until
				});
				var toDoTime = timeSheet.workTime.MinutesToDo({
					From: yearStart,
					To: until 
				});
				var overTime = timeSheet.workTime.OverTimeDone({
					From: yearStart,
					To: until 
				});
				var vacations = timeSheet.workTime.HolidayDoneDay({
					From: yearStart,
					To: until 
				});

				timeSheet.set('Worked', workedTime);
				timeSheet.set('Over', overTime);
				timeSheet.set('Todo', toDoTime);
				timeSheet.set('Sold', (workedTime + overTime) - toDoTime);
				timeSheet.set('Vacations', Round10(timeSheet.workTime.HolidayCount - vacations, 2));
				timeSheet.set('TotalVacations', timeSheet.workTime.HolidayCount);

				timeSheet.workTime.forEachWorkedDay(function (date, minutes){
					var boxId = sprintf("daybox_%s_%02d_%02d_%d", targetId, date.getDate(), date.getMonth() + 1, date.getFullYear());
					var nBoxId = sprintf("%02d_%02d_%d", date.getDate(), date.getMonth() + 1, date.getFullYear());
					if(djDom.byId(boxId)) {
						djDomConstruct.place(djDomConstruct.create('SPAN', { class: 'totalDayTime', innerHTML: "E : " + timeSheet.workTime.printTime(minutes)}), djDom.byId(boxId).firstChild, "after");
					}
					if(dayBoxes[targetId][nBoxId]) {
						dayBoxes[targetId][nBoxId].set("workedTime", minutes);	
					}
				});	

				timeSheet.checkValidation();

				var day = new Date();
				/* This set the current selected day in the add form box */
				if(lastAddedDay[timeSheet.target]) {
					day = lastAddedDay[timeSheet.target];

					if(timeSheet.workTime.getTimeForWorkedDay(day) + timeSheet.workTime.getTimeForAwayDay(day)
						>= (timeSheet.workTime.GetWholeDay() - 5)) {
						day = djDate.add(day, "day", 1);
					} else {
					}
				} else {
					if(timeSheet.workTime.lastRegistredDay != null) {
						if(timeSheet.workTime.getTimeForWorkedDay(timeSheet.workTime.lastRegistredDay[0]) + 
							+ timeSheet.workTime.getTimeForAwayDay(timeSheet.workTime.lastRegistredDay[0]) >= (timeSheet.workTime.GetWholeDay(timeSheet.workTime.lastRegistredDay[0]) - 5)) {
							day = djDate.add(timeSheet.workTime.lastRegistredDay[0], "day", 1);
						} else {
							day = timeSheet.workTime.lastRegistredDay[1]>1 ? 
								djDate.add(timeSheet.workTime.lastRegistredDay[0], "day", 1) :
								timeSheet.workTime.lastRegistredDay[0];
							
						}
					}
				}

				if(day.getDay() == 0 || day.getDay() == 6) {
					day = djDate.add(day, "day", 1);
					if(day.getDay() == 0) {
						day = djDate.add(day, "day", 1);
					}	
				}

				while(timeSheet.workTime.isHoliday(day)) {
					day = djDate.add(day, "day", 1);
				}

				timeSheet.setSelectedDate(day);

				def.resolve();
			});


	return def;
}

var onPersonSelect = function(event) {
	var targetId = dtRegistry.getEnclosingWidget(event.target).id;
	FragId.set(targetId);
	fullAddFormEx();
}

var onAddPerson = function(event) {
	personFormEx();
}

var onAddHolidays = function(event) {
	holidaysFormEx();	
	displayHolidayEx();
}

function decHourToStrHour(h) {
	var _h = Math.trunc(h/100);
	var _m = (h/100 - _h) * 60;
	if(_h < 10) { _h = "0" + _h; }
	if(_m < 10) { _m = "0" + _m; }
	return _h + ":" + _m;
}

var displayConditionEx = function() {
	console.log('displayConditionEx');
	var conditionTable = djDom.byId('conditionTable');

	if(conditionTable) {
		djDomConstruct.empty('conditionTable');
	} else {
		conditionTable = djDomConstruct.create('table', { id: 'conditionTable' });
		djDomConstruct.place(conditionTable, djDom.byId('conditionForm'));
	}

	conditionStore.forEach(function(entry){
		if(djDom.byId(entry.id) == null) {
			var begin = entry.begin != null? printDate(new Date(entry.begin)) : "";
			var end = entry.end != null ? printDate(new Date(entry.end)) : "";
			
			var html = "<tr><th scope=rowgroup class=\"title\">" + entry.name;
			html += ' <a href="#" id="_delete_' + entry.id + '">Supprimer</a>';

			if(entry.default == 0) {
				html += ' <a href="#" id="_default_' + entry.id + '">Selectionner par défaut</a>';
			}
			html += "<tr><th scope=row>Valable du<td>" +begin + "<th scope=row>Au<td>" + end;
			html += "<tr><th scope=row>Travail de nuit<th scope=row>de<td>";
			entry.beginNight == null ? html += "" : html += decHourToStrHour(entry.beginNight);
			html += "<th>à<td>"
			entry.endNight == null ? html += "" : html += decHourToStrHour(entry.endNight);
			html += "<tr><th scrop=row>Surcoût<th scope=row>de nuit<td>";
			entry.nightCost == null ? html += "" : html += (entry.nightCost - 100) + " %";
			html += "<td scope=row>ferié<td>";
			entry.holidaysCost == null ? html += "" : html += (entry.holidaysCost - 100) + " %";
			html += "<th scope=row>le dimanche<td>";
			entry.sundayCost == null ? html += "" : html += (entry.sundayCost - 100) + " %";
			html += "<tr><th scope=row>Heures par semaine<td>";
			entry.weekHours == null ? html += "" : html += entry.weekHours / 100;
			html += "<tr><th scope=row>Jour de vacance par année<td>";
			entry.vacations == null ? html += "" : html += entry.vacations;

			djDomConstruct.place(djDomConstruct.create('tbody', { innerHTML: html, id: entry.id}), conditionTable);
			djOn(djDom.byId('_delete_' + entry.id), 'click', function(evt){
				evt.preventDefault();
				if(confirm('Voulez-vous vraiment supprimer "' + entry.name + '"')) {
					conditionStore.remove(entry.id);
					displayConditionEx();	
				}
			});
			if(djDom.byId('_default_'+entry.id)){
				djOn(djDom.byId('_default_' + entry.id), 'click', function(evt) {
					evt.preventDefault();
					conditionStore.put({'id': entry.id }, { 'id': '__default' }).then(function(e){ displayConditionEx(); });
				});
			}
		}
	});
}

var displayHolidayEx = function() {
	console.log('displayHolidayEx');
	var holidayTable = djDom.byId('holidayTable');
	if(holidayTable) {
		djDomConstruct.empty('holidayTable');
	} else {
		holidayTable = djDomConstruct.create('table', { id: 'holidayTable' });
		djDomConstruct.place(holidayTable, djDom.byId('holidaysForm'));
	}

	holidayStore.forEach(function (e){
		var day = e.day.split('-');
		var html = "<tr><td>" + day[2] + '.' + day[1] + '.' + day[0];
		if(e.name) {
			html += " : " + e.name;
		}
		html +="</td>";
		html += '<td><a href="#" id="' + e.id + '">Supprimer</a></td>';
		html += "</tr>";
		djDomConstruct.place(djDomConstruct.create('tbody', {innerHTML: html}), holidayTable);
		djOn(djDom.byId(e.id), "click", function(e) {
			holidayStore.remove(e.target.id);
			displayHolidayEx();			
		});
	});
}

var holidaysFormEx = function() {
	console.log('holidaysFormEx');
	if(! dtRegistry.byId('holidaysForm')) {
		var holidaysPane = new dtContentPane({id: 'holidaysForm', title: 'Fériés'});
		djDomConstruct.place(djDomConstruct.create('H2', { innerHTML: 'Fériés'}), holidaysPane.domNode, 'last');
		
		var addHolidaysForm = new dtForm({id: 'addHolidaysForm'});
		new dtTextarea({name: 'holidays'}).placeAt(addHolidaysForm);
		djDomConstruct.place(djDomConstruct.create('BR'), addHolidaysForm.domNode);
		new dtButton({value: "Ajouter", innerHTML: "Ajouter", type: 'submit'}).placeAt(addHolidaysForm, "last");
	
		addHolidaysForm.placeAt(holidaysPane);	
		dtRegistry.byId('formStackContainer').addChild(holidaysPane);			
		
		addHolidaysForm.on('submit', function(e) {
			e.preventDefault();
      var jsonRequest = { 'holidays' : [] };
			var formValue = this.getValues();
			formValue.holidays.split("\n").forEach(function(d){
				var dn = d.split(' ');
				var _date = dn.shift();
				var name = dn.length ? dn.join(' ') : null;
				var date = _date.split('.');
				jsonRequest.holidays.push({ 'date': new Date(date[2], parseInt(date[1]) - 1, date[0], 12, 0, 0), 'name': name });
			});
		  
      if(jsonRequest.holidays.length > 0) {
        holidayStore.add(jsonRequest).then(function(res){
        	displayHolidayEx();
				});
      }

    });
	}

	dtRegistry.byId('formStackContainer').selectChild(dtRegistry.byId('holidaysForm'), true);
}

var personFormEx = function() {
	console.log('personFormEx');
	var pList = PERSON.htmlList();

	if(! dtRegistry.byId('personForm')) {
		var PersonPane = new dtContentPane({id: 'personForm', title: 'Personnes'});

		djDomConstruct.place(djDomConstruct.create('H2', { innerHTML: 'Personnes'}), PersonPane.domNode, 'last');

		/* Add Person Form */
		var addPersonForm = new dtForm({id: 'addPersonForm'});
		djDomConstruct.place(djDomConstruct.create('LABEL', { for: 'lastname', innerHTML: 'Nom'}), addPersonForm.domNode);
		new dtTextBox({name: 'lastname'}).placeAt(addPersonForm);
		djDomConstruct.place(djDomConstruct.create('LABEL', { for: 'firstname', innerHTML: 'Prénom'}), addPersonForm.domNode);
		new dtTextBox({name: 'firstname'}).placeAt(addPersonForm);
		djDomConstruct.place(djDomConstruct.create('BR'), addPersonForm.domNode);
		
		djDomConstruct.place(djDomConstruct.create('LABEL', { for: 'worktime', innerHTML: 'Taux d\'activité'}), addPersonForm.domNode);
		new dtNumberTextBox({name : 'worktime'}).placeAt(addPersonForm);
		djDomConstruct.place(djDomConstruct.create('LABEL', { for: 'vacations', innerHTML: 'Vacances'}), addPersonForm.domNode);
		new dtNumberTextBox({name : 'vacations'}).placeAt(addPersonForm);
		djDomConstruct.place(djDomConstruct.create('BR'), addPersonForm.domNode);
		
		djDomConstruct.place( djDomConstruct.create('LABEL', { innerHTML: 'Conditions '}), addPersonForm.domNode, "last");
		dtFilteringSelect({name: 'condition', store: new dsAdapter(conditionStore), value: '', searchAttr: 'name', required: false}).placeAt(addPersonForm, "last");
		djDomConstruct.place(djDomConstruct.create('BR'), addPersonForm.domNode);
		
		new dtButton({value: "Ajouter", innerHTML: "Ajouter", type: 'submit'}).placeAt(addPersonForm, "last");

		addPersonForm.on('submit', function(e) {
			e.preventDefault();
			if(this.validate()) {
				var formValue = this.getValues();
				var requestJson = {};
				
				requestJson.commonName = formValue.firstname + ' ' + formValue.lastname;

				requestJson.workTime = formValue.worktime == "" ? null : parseInt(formValue.worktime);
				requestJson.vacations = formValue.vacations == "" ? null : parseInt(formValue.vacations);
				requestJson.type = 'PERSON';
				requestJson.condition = formValue.condition == "" ? null : formValue.condition;

				entityStore.add(requestJson).then(function(res) {
					if(res.success) {
						window.location = window.location;
					} else {
						console.log("error for " + requestJson.commonName);
					}	
				});
			}
		});
		addPersonForm.placeAt(PersonPane);
		djDomConstruct.place(djDomConstruct.create('DIV', {id: 'personList'}), PersonPane.domNode, 'last');
		dtRegistry.byId('formStackContainer').addChild(PersonPane);			
	}

	pList.then(function(l) {
		var phtml = djDom.byId('personList');
		djDomConstruct.empty(phtml);
		djDomConstruct.place(l.domNode, phtml, 'last');
	});

	dtRegistry.byId('formStackContainer').selectChild(dtRegistry.byId('personForm'), true);
}

var conditionFormEx = function() {
	if(! dtRegistry.byId('conditionForm')) {
		var ConditionPane = new dtContentPane({id: 'conditionForm', title: 'Conditions'});
		djDomConstruct.place(djDomConstruct.create('H2', { innerHTML: 'Conditions' }), ConditionPane.domNode, 'last');


		/* Add Condition Form */
		var addCondForm = new dtForm({id:'addCondForm'});
		djDomConstruct.place(djDomConstruct.create('LABEL', { for: 'name', innerHTML: 'Nom'}), addCondForm.domNode);
		new dtTextBox({name: 'name', id: 'name'}).placeAt(addCondForm);
		djDomConstruct.place(djDomConstruct.create('BR'), addCondForm.domNode);

		djDomConstruct.place(djDomConstruct.create('LABEL', { for: 'begin', innerHTML: 'Début '}), addCondForm.domNode);
		var beginWidget = new dtDateTextBox({name: 'begin', constraints: {datePattern: 'dd.MM.yyyy'}}).placeAt(addCondForm);
		djDomConstruct.place(djDomConstruct.create('LABEL', { for: 'end', innerHTML: 'Fin '}), addCondForm.domNode);
		var endWidget = new dtDateTextBox({name: 'end', constraints: {datePattern: 'dd.MM.yyyy'}}).placeAt(addCondForm);
		djDomConstruct.place(djDomConstruct.create('BR'), addCondForm.domNode);

		/* Work details */
		djDomConstruct.place(djDomConstruct.create('LABEL', { for: 'weekhours', innerHTML: 'Travail hebdomadaire'}), addCondForm.domNode);
		new dtNumberTextBox({name: 'weekhours', id: 'weekHours'}).placeAt(addCondForm);
		djDomConstruct.place(djDomConstruct.create('LABEL', { for: 'vacations', innerHTML: 'Vacances annuelles'}), addCondForm.domNode);
		new dtNumberTextBox({name: 'vacations', id: 'Vacations'}).placeAt(addCondForm);
		djDomConstruct.place(djDomConstruct.create('BR'), addCondForm.domNode);
	
		/* Night work */	
		djDomConstruct.place(djDomConstruct.create('LABEL', { for: 'beginnight', innerHTML: 'Travail de nuit de '}), addCondForm.domNode);
		var beginnight  = new dtTimeTextBox({name: "beginnight", id: 'beginNightWidget', constraints: {timePattern: "HH:mm"}}).placeAt(addCondForm, "last");		
		djDomConstruct.place(djDomConstruct.create('LABEL', { for: 'endnight', innerHTML: ' à '}), addCondForm.domNode);
		var beginnight  = new dtTimeTextBox({name: "endnight", id: 'endNightWidget', constraints: {timePattern: "HH:mm"}}).placeAt(addCondForm, "last");		
		djDomConstruct.place(djDomConstruct.create('LABEL', { for: 'nightcost', innerHTML: ' au taux '}), addCondForm.domNode);
		new dtTextBox({name: 'nightcost', id: 'nightCost'}).placeAt(addCondForm);
		djDomConstruct.place(djDomConstruct.create('BR'), addCondForm.domNode);
	
		/* Taux */
		djDomConstruct.place(djDomConstruct.create('LABEL', { for: 'sundaycost', innerHTML: 'Taux dominical'}), addCondForm.domNode);
		new dtTextBox({name: 'sundaycost', id: 'sundayCost'}).placeAt(addCondForm);
		djDomConstruct.place(djDomConstruct.create('LABEL', { for: 'holidayscost', innerHTML: 'Taux férié'}), addCondForm.domNode);
		new dtTextBox({name: 'holidayscost', id: 'holidaysCost'}).placeAt(addCondForm);
		djDomConstruct.place(djDomConstruct.create('BR'), addCondForm.domNode);
		
		var addBtn = new dtButton({value: "Ajouter", innerHTML: "Ajouter", type: 'submit'}).placeAt(addCondForm, "last");

		addCondForm.on('submit', function(e) {
			e.preventDefault();
			if(this.validate()) {
				var formValue = this.getValues();
				var requestJson = {};
				requestJson.beginNight = formValue.beginnight ?
								(formValue.beginnight.getHours() * 100) + 
										(formValue.beginnight.getMinutes() / 60 ) 
								: null; /* decimal */
				requestJson.endNight = formValue.endnight ? 
								(formValue.endnight.getHours() * 100) + 
										(formValue.endnight.getMinutes() / 60 * 100 ) 
								: null; /* decimal */
				requestJson.vacations = formValue.vacations == "" ? null : parseInt(formValue.vacations, 10);
				requestJson.holidaysCost = formValue.holidayscost == "" ? null : parseInt(formValue.holidayscost, 10); /* percent */
				requestJson.nightCost = formValue.nightcost == "" ? null : parseInt(formValue.nightcost, 10); /* percent */
				requestJson.sundayCost = formValue.sundaycost == "" ? null : parseInt(formValue.sundaycost, 10); /* percent */
				requestJson.weekHours = formValue.weekhours == "" ? null : Math.trunc(parseFloat(formValue.weekhours) * 100);
				requestJson.name = formValue.name;

				requestJson.begin = formValue.begin ? 
								formValue.begin.getFullYear() + "-" + 
										(formValue.begin.getMonth() + 1)	+ "-" +
										formValue.begin.getDate() 
				  			: null;
				requestJson.end = formValue.end ? 
								formValue.end.getFullYear() + "-" + 
										(formValue.end.getMonth() + 1)	+ "-" +
										formValue.end.getDate() 
				  			: null;

				conditionStore.add(requestJson).then(function(res){
					if(res.success) {
						displayConditionEx();		
					} else {
					}	
				});
			}
		});

		addCondForm.placeAt(ConditionPane);	
		dtRegistry.byId('formStackContainer').addChild(ConditionPane);			
	}

	dtRegistry.byId('formStackContainer').selectChild(dtRegistry.byId('conditionForm'), true);
}

var onCondition = function(event) {	
	conditionFormEx();
	displayConditionEx();
}

djParser.parse().then(function(){

	var select = document.createElement('SELECT');
	for(var i = 2017; i <= new Date(Date.now()).getFullYear(); i++) {
		var option = document.createElement('OPTION');
		option.setAttribute('value', i);
		if(i == new Date(Date.now()).getFullYear()) {
			option.setAttribute('selected', 'selected');	
		}
		option.appendChild(document.createTextNode(i));
		select.appendChild(option);
	}
	document.getElementById('menu').appendChild(select);
	djOn(select, 'change', function (event) {
		CurrentYear = event.target.value;
		yearStart = new Date(Date.UTC(CurrentYear, 0, 1));
		yearStop = new Date(Date.UTC(CurrentYear, 11, 31));
		fullAddFormEx();
	});


	/* Containers */
	var FormContainer = new dtStackContainer({ id: "formStackContainer"	}, 'addFormDiv');
	var wait = new dtContentPane({id:'wait', content: '<i class="fa fa-spinner fa-pulse fa-3x fa-fw"></i>'});
	FormContainer.addChild(wait);


	/* Menu */
	var Menu = new dtAccordionContainer({ }, "entity");
	var Personnes = new dtMenu({title: "Personnes", style: "width: 100%"});
	var Content2 = new dtMenu({title: "Special", style: "width: 100%"});

	Menu.addChild(Personnes);
	Menu.addChild(Content2);

	Content2.addChild(new dtMenuItem({label: "Conditions", onClick: onCondition}));
	Content2.addChild(new dtMenuItem({ label: "Personne", onClick: onAddPerson }));
	Content2.addChild(new dtMenuItem({ label: "Fériés", onClick: onAddHolidays }));

	entityStore.filter({type: 'PERSON'})
		.forEach(function(person){
			Entities[person.id] = person;
			Personnes.addChild(new dtMenuItem({label: person.commonName, id: person.id,
			  onClick: onPersonSelect }));
		}).then(function() {  FormContainer.startup(); Menu.startup();  fullAddFormEx(); });


});
});
</script>
