<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" type="text/css" href="css/admin.css" />
  <link rel="stylesheet" type="text/css" href="css/dtable.css" />
  <title>Horaire</title>
  <link href="https://fonts.googleapis.com/css?family=Passion+One" rel="stylesheet">
</head>
<body>
  <nav><ul><li><a href="index.html">Home</a></li>
      <li><a href="process.html">Processus</a></li>
      <li><a href="user.html">Utilisateurs</a></li>
      <li><a href="time.html">Temps</a></li>
    </ul>
  </nav>
  <main>
  <h1>Projets</h1>
  <h2>Nouveau projet</h2>
  <form>
    <fieldset name="general">
      <legend>Général</legend>
      <label for="reference">Numéro de chantier : </label><input name="reference" type="text" /> <label for="year">Année : </label><input id="inYear" name="year" type="text" /><br>
      <label for="name">Nom : </label><input name="name" type="text" /><br>
      <label for="uncount">Heures non-comptabilisées : </label><input name="uncount" type="checkbox" /><br>
    </fieldset>
    <fieldset name="details">
      <legend>Détails</legend>
      <label for="subref">Référence : </label><input name="subref" type="text" /> <label for="meeting">Rendez-vous :</label><input name="meeting" type="text" /><br>
      <label for="contact">Personne de contact : </label><input name="contact" type="text" /> <label for="cphone">Téléphone : </label><input name="cphone" type="text" /><br>
      <label for="description>">Description du travail</label><br>
      <textarea name="description"></textarea>
    </fieldset>
    <!-- <label for="end">Date de fin : </label><input name="name" type="date" /><br> //-->
    <input type="submit" value="Ajouter"/><br>
  </form>
  <h2>Projets existants</h2>
  <input type="radio" onchange="changeState(event)" checked="checked" id="stateOpen" name="state"><label for="stateOpen">Ouvert</label>
  <input type="radio" onchange="changeState(event)" id="stateClosed" name="state"><label for="stateClosed">Fermé</label>
  <input type="radio" onchange="changeState(event)" id="stateAny" name="state"><label for="stateAny">Tous</label>
  <table id="projects" data-source="Project">
    <thead><tr><th data-sort-type="integer">Référence</th><th>Nom</th><th data-sort-type="no">Action</th></tr></thead>
    <tbody>
    </tbody>
  </table>
  </main>
</body>
<script src="https://bitwiseshiftleft.github.io/sjcl/sjcl.js"></script>
<script src="https://artnum.ch/code/js/Date.js"></script>
<script src="https://artnum.ch/code/js/Path.js"></script>
<script src="https://artnum.ch/code/js/Query.js"></script>
<script src="https://artnum.ch/code/js/DTable.js"></script>
<script src="js/admin.js"></script>
<script>

var searchParams = {'search.closed': '-', 'search.deleted': '-', 'sort.reference': 'asc'}

function changeState (event) {
  switch(event.target.id) {
    case 'stateOpen': 
      searchParams['search.closed'] = '-'
      break;
    case 'stateClosed':
      searchParams['search.closed'] = '*'
      break;
    case 'stateAny': 
      delete searchParams['search.closed']
      break;
  } 
  load()
}

 async function addProject (event) {
   var form = event.target
   let el = form.getElementsByClassName('error')
   for (let i = 0; i < el.length; i++) {
     el[i].classList.remove('error')
   }
   for (; form.nodeName !== 'FORM'; form = form.parentNode);
   var oform = Admin.getForm(form)

   if (oform.name) {
     if (oform.reference) {
       var res = await Artnum.Query.exec(Artnum.Path.url('Project', {params: {'search.reference': oform.reference}}))
       if (res.success && res.length > 0) {
         if (!confirm(`La référence ${oform.reference} est déjà utilisée, voulez-vous créer un doublon ?`)) {
           return
         }
       }
     }

     if (!oform.year) {
       oform.year = String((new Date()).getFullYear())
     } else {
       if (String(parseInt(oform.year)) !== String(oform.year)) {
         alert('Année invalide')
         return
       }
     }
     let map = { subref: 'reference', cphone: 'phone'}
     let travail = {}
     let error = false
     ;['subref', 'meeting', 'contact', 'cphone'].forEach(function (i) {
       if (String(oform[i]).length > 160) {
         Admin.findInput(form, i).classList.add('error')
         error = true
       } else {
         if (map[i]) {
           travail[map[i]] = String(oform[i])
         } else {
           travail[i] = String(oform[i])
         }
       }
     })
     travail.description = oform.description
     if (error) {
       alert('Les entrées sont limitées à 160 caractères')
       return
     }

     Artnum.Query.exec(Artnum.Path.url('Project'), {method: 'POST', body: {name: oform.name, reference: (oform.reference ? oform.reference : null), uncount: oform.uncount? 1 : 0, year: oform.year}}).then(function (result) {
       if (result.success && result.length === 1) {
         let pId = result.data[0].id
         Artnum.Query.exec(Artnum.Path.url(`Project/${pId}`)).then(function (result) {
           if (result.success && result.length === 1) {
             travail.project = pId
             Artnum.Query.exec(Artnum.Path.url('Travail'), {method: 'POST', body: travail}).then(function (subresult) {
               if (subresult.success && subresult.length > 0) {
                 replaceAddEntry(newEntry(result.data))
               } else {
                 alert('Toutes les donnnées n\'ont pas pu être enregistrées')
               }
             })
           }
         })
       }
     })
   }
 }
 
async function delProject (event) {
  if (!event || !event.target) { return }
  var node = event.target
  if (node.getAttribute('data-id')) {
    var res = await Artnum.Query.exec(Artnum.Path.url('Project/' + node.getAttribute('data-id')), {method: 'DELETE', body: {id: node.getAttribute('data-id')}})
    if (res.success) {
      var tr = node
      for (; tr.nodeName !== 'TR'; tr = tr.parentNode);
      tr.parentNode.removeChild(tr)
    }
  }
}

async function evCloseProject (event) {
  if (event && event.target) {
    var node = event.target
    if (node.getAttribute('data-id')) {
      var close = (node.getAttribute('data-state') === 'open' ? (new Date()).toISOString() : null)
      var res = await Artnum.Query.exec(Artnum.Path.url('Project/' + node.getAttribute('data-id')), {method: 'PATCH', body: {id: node.getAttribute('data-id'), closed: close}})
      if (res.success && res.length === 1) {
        res = await Artnum.Query.exec(Artnum.Path.url('Project/' + res.data[0].id))
        if (res.success && res.length === 1) {
          var tr = newEntry(res.data)
          if (tr) {
            replaceAddEntry(tr)
          }
        }
      }
    }  
  } 
}

async function evCancelEdit (event) {
  if (event && event.target) {
    for (var node = event.target; node.nodeName !== 'TR'; node = node.parentNode);
    var tr = node
    if (!tr.getAttribute('data-edit') || tr.getAttribute('data-edit') === '0') {
      return
    }
    for (var td = node.firstChild; td; td = td.nextSibling) {
      if (td.getAttribute('data-original-value')) {
        td.innerHTML = td.getAttribute('data-original-value')
      }
    }
    event.target.parentNode.removeChild(event.target)
    tr.setAttribute('data-edit', '0')
  }
}

async function evEditLine (event) {
  if (event && event.target) {
    for (var node = event.target; node.nodeName !== 'TR'; node = node.parentNode);
    var tr = node
    if (!tr.getAttribute('data-edit') || tr.getAttribute('data-edit') === '0') {
      tr.setAttribute('data-edit', '1')
      for (var td = node.firstChild; td; td = td.nextSibling) {
        if (td.getAttribute('data-type')) {
          switch (td.getAttribute('data-type').toLowerCase()) {
            default:
            case 'text':
              if (td.getAttribute('data-name')) {
                var input = document.createElement('INPUT')
                input.setAttribute('name', td.getAttribute('data-name'))
                if (td.getAttribute('data-value')) {
                  input.value = td.getAttribute('data-value')
                } else {
                  input.value = td.innerHTML
                }
                td.setAttribute('data-original-value', input.value)
              }
              break
          }
          td.innerHTML = ''
          td.appendChild(input)
        }
      }
      
      var cancelButton = document.createElement('BUTTON')
      cancelButton.setAttribute('type', 'button')
      cancelButton.innerHTML = 'Annuler'
      cancelButton.addEventListener('click', evCancelEdit)
      event.target.parentNode.insertBefore(cancelButton, event.target.nextSibling)
    } else {
      var dataSource = null
      for (var x = tr; x; x = x.parentNode) {
        if (x.getAttribute('data-source')) {
          dataSource = x.getAttribute('data-source')
          break
        }
      }
      if (dataSource) {
        var inputs = tr.getElementsByTagName('INPUT')
        tr.setAttribute('data-edit', '0')
        var body = {id: tr.getAttribute('data-id')}
        for (var i = 0; i < inputs.length; i++) {
          body[inputs[i].getAttribute('name')] = inputs[i].value
        }

        var res = await Artnum.Query.exec(Artnum.Path.url(dataSource + '/' + body.id), {method: 'PATCH', body: body})
        if (res.success && res.length === 1) {
          res = await Artnum.Query.exec(Artnum.Path.url(dataSource + '/' + res.data[0].id))
          if (res.success && res.length === 1) {
            replaceAddEntry(newEntry(res.data))
          }
        }
      }
    }
  }
}

function newEntry (entry, edit = false) {
  var tr = null

  if (entry.id) {
    var exportButton = document.createElement('BUTTON')
    exportButton.setAttribute('type', 'button')
    exportButton.addEventListener('click', function (event) {
      if (event && event.target) {
        for (var node = event.target; node.nodeName !== 'TR'; node = node.parentNode);
        window.open(Artnum.Path.url('exec/export/project.php', {params: {pid: node.getAttribute('data-id')}}))
      }
    })
    exportButton.innerHTML = 'Exporter'

    var printButton = document.createElement('BUTTON')
    printButton.setAttribute('type', 'button')
    printButton.addEventListener('click', function (event) {
      if (event && event.target) {
        for (var node = event.target; node.nodeName !== 'TR'; node = node.parentNode);
        window.open(Artnum.Path.url('admin/exec/export/bon.php', {params: {pid: node.getAttribute('data-id')}}))
      }
    })
    printButton.innerHTML = 'Imprimer'

    var closeButton = document.createElement('BUTTON')
    closeButton.setAttribute('type', 'button')
    closeButton.setAttribute('data-id', entry.id)

    if (entry.closed === null) {
      closeButton.innerHTML = 'Clore'
      closeButton.setAttribute('data-state', 'open')
    } else {
      closeButton.innerHTML = 'Réouvrir'
      closeButton.setAttribute('data-state', 'close')
    }
    closeButton.addEventListener('click', evCloseProject)
    
    var editButton = document.createElement('BUTTON')
    editButton.setAttribute('type', 'button')
    editButton.innerHTML = 'Éditer'
    editButton.addEventListener('click', evEditLine)

    var delButton = document.createElement('BUTTON')
    delButton.setAttribute('type', 'button')
    delButton.setAttribute('data-id', entry.id)
    delButton.innerHTML = 'Supprimer'
    delButton.addEventListener('click', delProject)

    tr = document.createElement('TR')
    tr.setAttribute('data-id', entry.id)
    tr.innerHTML = '<td data-name="reference" data-type="text">' + (entry.reference ? entry.reference : '') + '</td>' +
    '<td data-name="name" data-type="text">' + (entry.name ? entry.name : '') + '</td>' 
    
    var td = document.createElement('TD')
    td.appendChild(editButton)
    td.appendChild(exportButton)
    td.appendChild(printButton)
    td.appendChild(closeButton)
    td.appendChild(delButton)
    tr.appendChild(td)
  }

  return tr
}

function replaceAddEntry (tr) {
  var table = document.getElementById('projects')
  Admin.insertEntry(tr, table)
}

async function load () {
  document.getElementById('inYear').value = String((new Date()).getFullYear())
  var forms = document.getElementsByTagName('FORM')
  forms[0].addEventListener('submit', function (event) {
    event.preventDefault()
    addProject(event)
  })
  var res = await Artnum.Query.exec(Artnum.Path.url('Project', {params: searchParams}))
  if (res.success) {
    var frag = document.createDocumentFragment()
    res.data.forEach(function (entry) {
      var tr = newEntry(entry)
      if (tr) {        
        frag.appendChild(tr)
      }
    })
    var table = document.getElementById('projects')
    var node = null
    for (node = table.firstChild; node.nodeName !== 'TBODY'; node = node.nextSibling);
    window.requestAnimationFrame(function () {
      node.innerHTML = ''
      node.appendChild(frag)
    })
  }

   var t = new Artnum.DTable({table: 'projects'})
}

window.addEventListener('load', load)
</script>
</html>
