<!DOCTYPE html>
<html>
<head>
  <title>Horaire</title>
  <link rel="stylesheet" type="text/css" href="css/admin.css" />
  <link rel="stylesheet" type="text/css" href="css/dtable.css" />
  <link href="https://fonts.googleapis.com/css?family=Passion+One" rel="stylesheet">
  <link rel="stylesheet" href="../node_modules/font-awesome/css/font-awesome.min.css" type="text/css" />
  <style>
    .fa { cursor: pointer; }
  </style>
</head>
<body>
<!--  <nav><ul><li><a href="index.html">Home</a></li>
      <li><a href="project.html">Projets</a></li>
      <li><a href="process.html">Processus</a></li>
      <li><a href="time.html">Temps</a></li>
    </ul>
  </nav> //-->
  <main>
  <h1>Utilisateurs</h1>
  <h2>Nouvel utilisateur</h2>
  <form>
    <label for="name">Nom : </label><input name="name" type="text" /><br>
    <label for="username">Utilisateur : </label><input name="username" type="text" /><br> 
    <label for="efficiency">Efficacité : </label><input name="efficiency" type="text" value="1" /> (min: 0.1, max 2.0)<br> 
    <label for="password">Mot de passe : </label><input name="password" type="password" /><br>
    <label for="level">Niveau d'accèss : <select name="level">
      <option value="256">Ajout temps</option>
      <option value="128">Gestion projet</option>
      <option value="64">Gestion projet et processus </option>
      <option value="32">Gestion temps, projet et processus</option>
      <option value="16">Gestion de tout</option>
    </select></label><br/>
    <label for="order">Ordre au planning : <input name="order" type="text" /><br>
    <input type="submit" value="Ajouter" />
</form>
<h2>Utilisateurs existants</h2>
<form>
   <table id="users" data-source="Person">
    <thead class="darkbg"><tr><th>Nom</th><th>Utilisateur</th><th data-sort-type="float">Efficacité</th><th data-sort-type="float">Prix horaire</th><th data-sort-type="bool">Actif</th><th data-sort-type="integer">Niveau</th><th data-sort-type="integer">Ordre au planning</th></th><th data-sort-type="no">Action</th></tr></thead>
    <tbody>
    </tbody>
  </table>
  </main>
</body>
<script src="../conf/kaal.js"></script>
<script src="js/lib/login.js"></script>
<script src="js/fetch.js"></script>
<script src="../node_modules/sjcl/sjcl.js"></script>
<script src="../node_modules/artnum/Date.js"></script>
<script src="../node_modules/artnum/Path.js"></script>
<script src="../node_modules/artnum/Query.js"></script>
<script src="../node_modules/artnum/DTable.js"></script>
<script src="js/admin.js"></script>
<script>
  const base = window.location.pathname.split('/')
  while (!base[0]) { base.shift() }
  const KLoginInstance = (new KLogin(new URL(`${window.location.origin}/${base.shift()}/`)))
  function makeKey (password) {
    var iteration = Math.floor(Math.random() * 1000) + 2000 // between 2000 and 2999 iteration
    var salt = sjcl.random.randomWords(4, 2)
    var outpass = sjcl.misc.pbkdf2(password, salt, iteration)
    return {key: sjcl.codec.base64.fromBits(outpass), keyopt: String(iteration) + ' ' + sjcl.codec.base64.fromBits(salt)}
  }

 function editUser (userId) {
   return new Promise((resolve, reject) => {
     Artnum.Query.exec(Artnum.Path.url(`Person/${userId}`)).then((result) => {
       if (!result.success || result.length !== 1) { reject(new Error('Pas d\'utilisateur')); return }
       let user = Array.isArray(result.data) ? result.data[0] : result.data
       let popup = window.Admin.popup(`<form>
         <input type="hidden" value="${user.id}" name="user" />
         <label for="username">Nom d'utilisateur : <input type="text" name="username" value="${user.username}" /></label><br>
         <label for="name">Nom : <input type="text" name="name" value="${user.name}" /></label><br>
         <label for="efficiency">Efficacité : <input name="efficiency" type="text" value="${user.efficiency}"></label> (min: 0.1, max: 2.0)<br>
         <label for="level">Niveau d'accèss : <select name="level">
            <option value="256">Ajout temps</option>
            <option value="128">Gestion projet</option>
            <option value="64">Gestion projet et processus </option>
            <option value="32">Gestion temps, projet et processus</option>
            <option value="16">Gestion de tout</option>
         </select></label><br/>
         <label for="password">Mot de passe : <input type="password" name="password" value=""></label><br><span class="notice" data-name="password-modified">Le mot de passe ne sera pas modifié</span><br>
         <label for="disabled"> Désactiver : <input type="checkbox" name="disabled" ${user.disabled === '0' ? '' : 'checked'} /></label><br>
         <label for="order">Ordre au planning : <input name="order" type="text" value="${user.order}"/><br>
         <button type="submit">Sauver</button><button type="reset">Annuler</button>
         </form>
       `, `Modifier utilisateur ${user.name}`, {closable: true})
       let form = popup.getElementsByTagName('form')[0]
       form.addEventListener('reset', (event) => {
         let p = event.target
         while (p && !p.classList.contains('popup')) { p = p.parentNode }
         p.dispatchEvent(new CustomEvent('close'))
       })
       form.addEventListener('keypress', (event) => {
         if (event.target.nodeName === 'INPUT' && event.target.name === 'password') {
           let node = event.target
           while (node && node.nodeName !== 'FORM') { node = node.parentNode }
           let nodes = node.getElementsByTagName('SPAN')
           for (let n of nodes) {
             if (n.dataset.name && n.dataset.name === 'password-modified') {
               window.requestAnimationFrame(() => { n.parentNode.removeChild(n) })
               break
             }
           }
         }
       })
       form.addEventListener('submit', (event) => {
         event.preventDefault()
         let content = window.Admin.getForm(event.target)
         Artnum.Query.exec(Artnum.Path.url('Person', {params: {'search.username': content.username}})).then((result) => {
           if (!result.success || result.length > 1) { reject(new Error('Une erreur est survenue')); console.log(result); return }
           if (result.length === 1) {
             if (result.data[0].id !== content.user) {
               alert('Nom d\'utilisateur déjà existant, veuillez choisir un autre')
               return
             }
           }
           let mapping = {username: 'username', name: 'name', efficiency: 'efficiency', level: 'level', order: 'order'}
           let body = {disabled: content.disabled ? '1' : '0'}
           for (let i in mapping) {
             if (content[i] && content[i] !== null) {
               body[mapping[i]] = content[i]
             } else {
               body[mapping[i]] = ''
             }
           }
           body.efficiency = parseFloat(body.efficiency)
           if (body.efficiency < 0.1 || body.efficiency > 2.0) {
             alert(`Une efficacité de ${body.efficiency} n'est pas acceptable, la valeur doit être entre 0.1 et 2.0`)
             return
           }
           body.level = parseInt(body.level)
           
           if (content.password) {
             if (content.password.length < 6) {
               alert('Mot de passe trop court, veuillez entrer au moins 6 caractères')
               return
             }
             Object.assign(body, makeKey(content.password))
           }
           if (content.user) { body.id = content.user }
           Artnum.Query.exec(Artnum.Path.url(`Person/${content.user}`), {method: body.id ? 'PATCH' : 'POST', body: body}).then((result) => {
             if (result.success) {
               let uid = result.data[0].id
               Artnum.Query.exec(Artnum.Path.url(`Person/${uid}`)).then((result) => {
                 if (!result.success || result.length !== 1) { reject(new Error('Une erreur est survenue')); console.log(result); return }
                 newEntry(Array.isArray(result.data) ? result.data[0] : result.data).then((html) => {
                   replaceAddEntry(html)
                   let p = event.target
                   while (p && !p.classList.contains('popup')) { p = p.parentNode }
                   p.dispatchEvent(new CustomEvent('close'))
                   resolve()
                 })
               })
             }
           })
         })
       })
     })
   })
 }

 function showConnections (userId, username) {
  return new Promise((resolve, reject) => {

    KLoginInstance.getActive(userId)
    .then(connections => {

      const popup = window.Admin.popup(`<form>
        <input type="hidden" value="${userId}" name="user" />
        <table>
          <tr><th>Navigateur</th><th>Adresse IP</th><th>Nom d'hote</th></tr>
        </table>
        <button type="submit">Déconnecter</button>
        </form>
        `, `Connections pour ${username}`, {closable: true})

      const form = popup.getElementsByTagName('form')[0]
      form.addEventListener('submit', event => {
        event.preventDefault()
        const data = new FormData(event.target)
        KLoginInstance.disconnect(data.get('user'))
        .then(_ => {
          getUser(data.get('user'))
          popup.close()
        })
      })
      const table = popup.getElementsByTagName('TABLE')[0]
      for (const connection of connections) {
        const tr = document.createElement('TR')
        tr.innerHTML = `<td>${connection.useragent}</td><td>${connection.remoteip}</td><td>${connection.remotehost}</td>`
        table.appendChild(tr)
      }
    })
  })
 }

 const levels = {
   256: 'Ajout de temps',
   128: 'Gestion de projet',
   64: 'Gestion de projet et processus',
   32: 'Gestion de temps, projet et processus',
   16: 'Gestion de tout'
 }
 
 function newEntry (entry, edit = false) {
   return new Promise((resolve, reject) => {
     let tr = null
     if (entry.id) {
       tr = document.createElement('TR')
       tr.setAttribute('data-id', entry.id)
       let level = ''
       let highest = 32768;
       for (let l in levels) {
         if (parseInt(l) >= parseInt(entry.level)) {
           if (parseInt(l) < highest) {
             level = levels[l]
             highest = parseInt(l)
           }
         }
       }
       
       tr.innerHTML =  `
         <td>${entry.name}</td>
         <td>${entry.username}</td>
         <td>${entry.efficiency}</td>
         <td>${entry.price}</td>
         <td>${(entry.disabled === '0' ? 'oui' : 'non')}</td>
         <td>${level}</td>
         <td>${entry.order}</td>
         <td>
         <button data-user="${entry.id}" data-username="${entry.name}" type="button" data-action="edit">Modifier</button>
         <button data-user="${entry.id}" data-username="${entry.name}" type="button" data-action="pricing">Tarif horaire</button>
         <button data-user="${entry.id}" type="button" data-action="connections">Connections (${entry._connections.length})</button>
         <button data-user="${entry.id}" data-username="${entry.name}" type="button" data-action="delete">Supprimer</button></td>`
     }
     resolve(tr)
   })
 }

 function getTable (source) {
   var tables = document.getElementsByTagName('TABLE')
   for (var i = 0; i < tables.length; i++) {
     if (tables[i].getAttribute('data-source') === source) {
       return tables[i]
      }
   }
   return null
 }

  function replaceAddEntry (tr) {
    var table = getTable('Person')
    var tbody = table.firstChild
    for (; tbody.nodeName != 'TBODY'; tbody = tbody.nextSibling);
    var id = tr.getAttribute('data-id')
    Admin.insertEntry(tr, table, id)
  }

  window.onload = async function () {
    var forms = document.getElementsByTagName('FORM')
    forms[0].addEventListener('submit', async function (event) {
      event.preventDefault()
      var user = { name: null, efficiency: 1.0, key: null, keyopt: null, password: null, admin: false, user: false, username: null, order: 0 }
      
      
      ; ['INPUT', 'SELECT'].forEach((ename) => {
        let inputs = event.target.getElementsByTagName(ename)
        for (var i = 0; i < inputs.length; i++) {
          switch (inputs[i].getAttribute('name')) {
            case 'efficiency':
              inputs[i].value = 1.0;
              inputs[i].value = parseFloat(inputs[i].value)
              if (inputs[i].value < 0.1 || inputs[i].value > 2.0) {
                alert(`Une efficacité de ${inputs[i].value} n'est pas acceptable, la valeur doit être entre 0.1 et 2.0`)
              }
            case 'name':
            case 'username':
              user[inputs[i].getAttribute('name')] = inputs[i].value
              inputs[i].value = ''
              break
            case 'password':
              user.password = inputs[i].value
              var key = makeKey(user.password)
              user.key = key.key
              user.keyopt = key.keyopt
              inputs[i].value = ''
              break
            case 'level':
              user.level = parseInt(inputs[i].value)
              inputs[i].value = 256
              break
            case 'order':
              user.order = parseInt(inputs[i].value)
              inputs[i].value = 0
              break
          }
        }
      })

      var exists = await Artnum.Query.exec(Artnum.Path.url('Person', {params: {'search.username': user.username}}))
      if (exists.success && exists.length > 0) {
        alert('Nom d\'utilisateur est déjà pris')
        return
      }

      if (user.key && user.name && user.keyopt && user.username && user.level) {
        Artnum.Query.exec(Artnum.Path.url('Person'), {method: 'POST', body: {order: user.order, level: user.level, name: user.name, key: user.key, keyopt: user.keyopt, username: user.username}}).then(function (result) {
          if (!result.success && result.length !== 1) {
            alert('Erreur de création des utilisateur')
          } else {
            Artnum.Query.exec(Artnum.Path.url('Person/' + result.data[0].id)).then(function (result) {
              loadUsers()
            })
          }
        })
      }
    })
    const UserTable = new Artnum.DTable({table: 'users'})
    window.addEventListener('update', (event) => {
      if (!event.detail)  { return }
      if (!event.detail.type) { return }
      switch (event.detail.type) {
        case 'user': 
          getUser(event.detail.id)
        break
      }
    })
    document.getElementById('users').addEventListener('click', (event) => {
      if (event.target.nodeName !== 'BUTTON') { return }
      let node = event.target
      while (node && node.nodeName !== 'TR') { node = node.parentNode }
      switch(event.target.dataset.action) {
        case 'edit':
          editUser(node.dataset.id)
          break
        case 'delete':
          deleteUser(node.dataset.id).then(() => {
            window.requestAnimationFrame(() => node.parentNode.removeChild(node))
          })
        case 'pricing':
          setUserPrice(node.dataset.id, event.target.dataset.username)
          break
        case 'connections':
          showConnections(node.dataset.id, node.dataset.username)
          break
      }
    })
    loadUsers()
  } 

  function setUserPrice (userId, username) {
    let url = new URL('../PrixHeure', window.location)
    url.searchParams.append('sort.validity', 'ASC')
    url.searchParams.append('search.person', userId)
    fetch(url, {headers: new Headers({'X-Request-Id': `${new Date().getTime()}-${performance.now()}`})}).then(response => {
      if (!response.ok) {
        alert('Indisponible')
      } else {
        response.json().then(result => {
          let html = ''
          for (let i = 0; i < result.length; i++) {
            let entry = result.data[i]
            let date = new Date(entry.validity)
            html += `<div data-id="${entry.id}" data-person="${userId}" data-date="${date.toISOString().split('T')[0]}" class="entry"><span class="begin">${date.fullDate()}</span><span class="amount">${parseFloat(entry.value)}</span><i class="fa fa-trash-o" aria-hidden="true"></i></div>`
          }
          html = `<div class="pricing">
              <div class="entry head"><span>Depuis</span><span>Montant</span></div>
              ${html === '' ? '<div class="nothing">Pas d\'horaire</div>' : html}
            </div>
            <form name="add">
              <label for="validity">Valable depuis </label><input type="date" name="validity" /><br />
              <label for="value">Prix horaire </label><input type="text" name="value">
              <input type="submit" value="Ajouter" /><input type="hidden" name="person" value="${userId}" />

            </form>`
          let popup = Admin.popup(html, `Tarif horaire - ${username}`, {closable: true, minWidth: '30ch'})
          popup.addEventListener('click', event => {
            if (event.target.classList.contains('fa-trash-o')) {
              let p = event.target.parentNode
              while (p && p.dataset.id === undefined) { p = p.parentNode }
              fetch(new URL(`../PrixHeure/${p.dataset.id}`, window.location), {
                method: 'DELETE',
                headers: new Headers({'X-Request-Id': `${new Date().getTime()}-${p.dataset.id}`})
              }).then(response => {
                if (response.ok) {
                  window.requestAnimationFrame(() => p.parentNode.removeChild(p))
                  window.dispatchEvent(new CustomEvent('update', {detail: {
                    type: 'user',
                    id: p.dataset.person
                  }}))
                }
              })
            }
          }, {capture: true})
          popup.addEventListener('submit', (event) => {
            event.preventDefault()
            let pTable = event.target.parentNode.firstElementChild
            while (pTable && !pTable.classList.contains('pricing')) { pTable = pTable.nextElementSibling }

            let values = Admin.getForm(event.target)
            if (values.validity && values.value) {
                values.value = parseFloat(values.value)
                values.validity = new Date(values.validity)
                if (!isNaN(values.value) && !isNaN(values.validity.getTime())) {
                  let url = new URL('../PrixHeure', window.location)
                  fetch(url, {
                    method: 'POST',
                    body: JSON.stringify({value: values.value, validity: values.validity, person: values.person}),
                    headers: new Headers({'X-Request-Id': `${new Date().getTime()}-${performance.now()}`})
                  }).then(response => {
                    if (response.ok) {
                      response.json().then(result => {
                        if (result.length === 1) {
                          window.dispatchEvent(new CustomEvent('update', {detail: {
                            type: 'user',
                            id: values.person
                          }}))
                          let id = Array.isArray(result.data) ? result.data[0].id : result.data.id
                          if (id) {
                            let date = new Date(values.validity)
                            let div = document.createElement('DIV')
                            div.dataset.id = id 
                            div.dataset.date =  date.toISOString().split('T')[0]
                            div.classList.add('entry')
                            div.innerHTML = `<span class="begin">${date.fullDate()}</span><span class="amount">${parseFloat(values.value)}</span><i class="fa fa-trash-o" aria-hidden="true"></i>`
                            if (
                              pTable.lastElementChild.classList.contains('nothing') ||
                              pTable.lastElementChild.classList.contains('head')
                            ) {
                              window.requestAnimationFrame(() => {
                                if(!pTable.lastElementChild.classList.contains('head')) {
                                  pTable.removeChild(pTable.lastElementChild)
                                }
                                pTable.appendChild(div)
                              })                            
                            } else {
                              let added = false
                              for (let n = pTable.firstElementChild; n; n = n.nextElementSibling) {
                                if (n.dataset.date > div.dataset.date) {
                                  window.requestAnimationFrame(() => pTable.insertBefore(div, n))
                                  added = true
                                  break
                                }
                              }
                              if (!added) {
                                window.requestAnimationFrame(() => pTable.appendChild(div))
                              }
                            }
                          }
                        }
                      })
                    }
                  })
                }
            }
          }, {capture: true})
          
        })
      }
    })
  }

 function deleteUser(userId) {
   return new Promise((resolve, reject) => {
     Artnum.Query.exec(Artnum.Path.url(`Person/${userId}`)).then((result) => {
       if (!result.success || result.length !== 1) { reject(new Error('Une erreur est survenue')); console.log(result); return }
       let user = Array.isArray(result.data) ? result.data[0] : result.data
       if (confirm(`Voulez-vous vraiment supprimer l'utilisateur ${user.name} ?`)) {
         Artnum.Query.exec(Artnum.Path.url(`Person/${user.id}`), {method: 'DELETE', body: {id: user.id}}).then((result) => {
           if (result.success) { resolve(); return}
           reject()
         })
       }
     })
   })
  }

  function getUser (id) {
    fetch(new URL(`../Person/${id}`, window.location), {
      headers: new Headers({'X-Request-Id': `${new Date().getTime()}-${id}`})
    }).then(response => {
        if (response.ok) {
          response.json().then(result => {
            if (result.length === 1) {
              const entry = Array.isArray(result.data) ? result.data[0] : result.data
              KLoginInstance.getActive(entry.id)
              .then(connections => {
                entry._connections = connections
                newEntry(entry)
                .then(html => {
                  replaceAddEntry(html)
                })
              })
            }
          })
        }
      })
  }

  async function loadUsers () {
    //var admin = await Artnum.Query.exec(Artnum.Path.url('admin/htpasswd.php'))
    Artnum.Query.exec(Artnum.Path.url('Person', {params: {'search.deleted': '-'}})).then(function (person) {
      if (person.success && person.length > 0) {
        for (var i = 0; i < person.length; i++) {
          const entry = person.data[i]
          /*if (admin.indexOf(entry.username) !== -1) {
            entry.admin = true
          } else {
            entry.admin = false
          }*/
          KLoginInstance.getActive(entry.id)
          .then(connections => {
            entry._connections = connections
            newEntry(entry)
            .then((html) => {
              replaceAddEntry(html)
            })
          })
        }
      } 
    })
  }
</script>
</html>
