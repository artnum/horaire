<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" type="text/css" href="css/admin.css" />
  <link rel="stylesheet" type="text/css" href="css/codebox.css" />
  <link rel="stylesheet" type="text/css" href="css/dtable.css" />
  <style type="text/css">
    .client.alt_0 {
      color: darkblue;
    }
    .client {
      max-width: 32ch !important;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .reference {
      max-width: 12ch !important;
      overflow: hidden;;
      text-overflow:  ellipsis;
    }
    .center {
      text-align: center;
    }
  </style>
<title>Horaire</title>
<link href="https://fonts.googleapis.com/css?family=Passion+One" rel="stylesheet">
</head>
<body>
  <h2>Ajout facture</h2>
  <form id="bill">
    <fieldset id="address">
      <legend>Adresse</legend>
    </fieldset>
    <fieldset id="detail">
      <legend>Détail facture</legend>
      <label>Type </label> <select name="type">
        <option value="1">Facture débiteur</option>
        <option value="2">Facture créancier</option>
        <option value="3">Note de crédit</option>
        <option value="4">Compensation</option>
      </select></label>
      <label>N° de facture <input type="text" name="reference" /></label>
      <label>Date <input type="text" name="date" /></label>
      <label>Délai <input type="text" name="duedate" value="30" data-default="30" /></label><br />
      <label>Montant (TVA incluse) <input type="text" name="amount" /></label>
      <label>Monnaie <select name="currency">
        <option value="chf" selected>CHF</option>
        <option value="eur">EUR [€]</option>
        <option value="usd">USD [$]</option>
        <option value="gbp">GBP [£]</option>
        <option value="jpy">JPY [¥]</option>
      </select></label><br />
      <label>Remarque <input type="text" name="comment" style="width: 120ch;"/></label>
    </fieldset>
    <fieldset id="link-target" class="link results">
      <legend>Lier à</legend>
      <input type="button" value="Lier ..." onclick="linkTo()"/>
    </fieldset>
    <fieldset data-type="repartition">
      <legend>Répartition du montant</legend>
      <div class="note">
        Les montants indiqués en valeur absolue sont hors TVA. Les montants exprimés en pourcent inlcuent la TVA.
      </div>
      <div data-type="repartitionFrag">
      <label>Projet <input type="text" name="project" tabindex></label>
      <label>Montant <input type="text" name="value" tabindex></label>
      <label>TVA <input name="tva" type="text" data-default="7.7" tabindex value="7.7"></label>
      </div>
    </fieldset>
    <input type="submit" value="Ajouter" />
  </form>
  <h2>Factures enregistrées</h2>
  <table id="facture" data-source="Facture" data-options="{}" data-entry-id="id">
    <thead class="darkbg"><tr>
      <th data-attribute="indate:date">Date d'entrée</th>
      <th data-attribute="date:date">Date de facture</th>
      <th data-attribute="duedate:date">Payable</th>
      <th data-class="reference" data-attribute="reference">N° de facture</th>
      <th data-class="client" data-attribute="@../$person displayname|person">Adresse</th>
      <th data-attribute="amount:money" data-sort-type="money">Montant</th>
      <th data-attribute="currency">Devise</th>
      <th data-class="center" data-attribute="type~1=Facture débiteur,2=Facture créancier,3=Note de crédit,4=Compensation" data-sort-type="int">Type</th>
      <th data-class="center" data-attribute="paid~0=non,1=oui">Payée</th>
      <th data-class="center" data-attribute="paiement" data-sort-type="int">Nbre paiements</th>
      <th data-class="center" data-attribute="repartition" data-sort-type="int">Répartitions</th>
    </tr></thead>
    <tbody>
    </tbody>
  </table>
</body>
<script src="../conf/kaal.js"></script>
<script type="module" src="js/bill.js"></script>
<script src="../node_modules/sjcl/sjcl.js"></script>
<script src="../node_modules/popper.js/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/transliteration@2.1.3/dist/browser/bundle.umd.min.js"></script>
<script src="/js/String.js"></script>
<script src="/js/Path.js"></script>
<script src="/js/Select.js"></script>
<script src="/js/Query.js"></script>
<script src="/js/Date.js"></script>
<script src="/js/DTable.js"></script>
<script src="js/admin.js"></script>
<script src="js/stores.js"></script>
<script type="module">
  import {Address} from './js/address.js'
  const address = new Address(document.getElementById('address'))
</script>
<script>
  function SearchBill (param, term) {
    return new Promise((resovle, reject) => {
      let url = new URL('../Facture', window.location)
      switch (param) {
        case 'reference':
          url.searchParams.append('search.reference', `~${term.trim()}%`)
          break
        case 'amount':
          url.searchParams.append('search.amount', `${term.trim()}`)
          break
        case 'date':
          let date = Date.EUParse(term)
          if (!isNaN(date.getTime())) {
            url.searchParams.append('search.date', `~${date.toISOString()}`)
          } else {
            return
          }
          break
      }
      fetch(url).then(response => {
        if (response.ok) {
          response.json().then(results => {
            if (results.length > 0) {
              if (!Array.isArray(results.data)) {
                results.data = [results.data]
              }
            } else {
              results.data = []
            }
            resovle(results.data)
          })
        } else {
          reject(new Error('Pas de résultats'))
        }
      }, reason => reject(reason))
    })
  } 

  function extendBill () {

  }

  const facture = new Artnum.DTable({table: document.getElementById('facture')})
  facture.transliterate = transliterate

  function linkTo () {
    Admin.fetchPopup('html_frag/linkbill.html', 'Lier facture', { closable: true, minWidth: '40%' }).then(popup => {
      popup.addEventListener('submit', event => {
        event.preventDefault()
        switch (event.target.getAttribute('name')) {
          case 'searchBill':
            let search = Admin.getForm(event.target)
            if (search.terms && search.searchby) {
              let queries = []
              queries.push(SearchBill(search.searchby, search.terms))
              Promise.all(queries).then(results => {
                let outRes = []
                results.forEach(result => {
                  if (Array.isArray(result) && result.length > 0) {
                    outRes = [...outRes, ...result]
                  }
                })
                let addrs = []
                let Addresses = {}
                outRes.forEach(bill => {
                  if (bill.person === '') { return }
                  if (Addresses[bill.person] === undefined) {
                    addrs.push(new Promise((resolve, reject) => {
                      fetch(`../${bill.person}`, window.location).then(response => {
                        if (response.ok) {
                          response.json().then(result => {
                            if (result.length > 0) {
                              if (Array.isArray(result.data)) {
                                result.data = result.data[0]
                              }
                              resolve(result.data)
                            } else {
                              reject(new Error('Contact introuvable'))
                            }
                          }, reason => reject(reason))
                        } else {
                          reject(new Error('Contact introuvable'))
                        }
                      }, reason => reject(reason))
                    }))
                    Addresses[bill.person] = addrs.length - 1
                  }
                })
                let ids = []
                let divs = event.target.getElementsByTagName('DIV')
                let resultDiv
                for (let div of divs) {
                  if (div.getAttribute('name') === 'link-results') {
                    resultDiv = div
                    break
                  }
                }
                if (addrs.length === 0) {
                  let node = resultDiv.firstElementChild
                  while (node) {
                    let current = node
                    node = node.nextElementSibling
                    if (current.dataset.static) { continue }
                    if (ids.indexOf(current.id) === -1) {
                    window.requestAnimationFrame(() => current.parentNode.removeChild(current))
                    }
                  }
                  return
                }
                Promise.all(addrs).then(addrs => {
                  for (let i in outRes) {
                    let person = outRes[i].person
                    if (Addresses[person] !== undefined) {
                      outRes[i].person = addrs[Addresses[person]]
                    }
                  }

                  outRes.forEach (bill => {
                    let d = document.createElement('DIV')
                    d.id = `link-result-${bill.id}`
                    ids.push(d.id)
                    let adresse = ''
                    if (bill.person && bill.person.displayname) {
                      adresse = bill.person.displayname
                    }
                    d.innerHTML = `<span class="reference">${bill.reference}</span><span class="amount">${Admin.formatMoney(bill.amount, bill.currency)}</span><span class="date">${new Date(bill.date).fullDate()}</span><span class="address">${adresse}</span>`
                    if (document.getElementById(d.id)) {
                      window.requestAnimationFrame(() => resultDiv.replaceChild(d, document.getElementById(d.id)))
                    } else {
                      window.requestAnimationFrame(() => resultDiv.appendChild(d))
                    }
                    d.addEventListener('click', (event) => {
                      let node = event.target
                      while (node && node.nodeName !== 'DIV') { node = node.parentNode }
                      window.requestAnimationFrame(() => node.classList.add('selected'))
                      for(let other = node.parentNode.firstElementChild; other; other = other.nextElementSibling) {
                        if (other.id !== node.id && other.classList.contains('selected')) {
                          window.requestAnimationFrame(() => other.classList.remove('selected'))
                        }
                      }
                    })
                  })
                

                 let node = resultDiv.firstElementChild
                  while (node) {
                    let current = node
                    node = node.nextElementSibling
                    if (current.dataset.static) { continue }
                    if (ids.indexOf(current.id) === -1) {
                    window.requestAnimationFrame(() => current.parentNode.removeChild(current))
                    }
                  }
                })
              })
            }
            break
          case 'Link':
            let link = Admin.getForm(event.target)
            let popup = event.target.parentNode
            while (popup && popup.nodeName !== 'DIV') { popup = popup.parentNode }
            let selectedDiv = popup.querySelector('form[name="searchBill"] div[name="link-results"] div.selected')
            if (selectedDiv) {
              let div = selectedDiv.cloneNode(selectedDiv)
              div.dataset.linkType = link.type
              div.dataset.linkId = selectedDiv.id.split('-').pop()
              div.removeAttribute('id')
              let target = document.getElementById('link-target')
              let valid = true
              for (let link = target.firstElementChild; link; link = link.nextElementSibling) {
                if (link.dataset.linkId === div.dataset.linkId) {
                  valid = false;
                  break;
                }
              }
              let type = document.createElement('SPAN')
              type.classList.add('type')
              switch(div.dataset.linkType) {
                case '1': 
                  type.innerHTML = 'Note de crédite / Compensation'
                  break
                case '2': 
                  type.innerHTML = 'Rappel'
                  break
                case '3': 
                  type.innerHTML = 'Sommation'
                  break
                case '4': 
                  type.innerHTML = 'Poursuite'
                  break
              }
              div.insertBefore(type, div.firstElementChild)
              div.classList.remove('selected')
              if (valid) {
                window.requestAnimationFrame(() => target.appendChild(div))
              }
            }
            popup.dispatchEvent(new Event('close'))
            break
        }
      }, { capture: true })
      popup.addEventListener('reset', event => {
        event.preventDefault()
        popup.dispatchEvent(new Event('close'))
      }, { capture: true })
    })
  }

  let inputs = document.getElementsByTagName('INPUT')
  for (let i = 0; i < inputs.length; i++) {
    if (inputs[i].getAttribute('name') === 'project') {
      Select(inputs[i], new STProject('Project'), {realSelect: true, allowFreeText: false})
    }
  }

  let f = document.getElementById('bill').addEventListener('submit', event => {
    event.preventDefault()
    Admin.setFormInputInvalid(document.getElementById('bill'), '*', '', true)
    let values = window.Facture.getValues()
    let postData = {
      reference: values.reference !== undefined ? values.reference : '',
      currency: values.currency !== undefined ? values.currency : 'chf',
      date: values.date !== undefined ? values.date : '',
      duedate: values.duedate !== undefined ? values.duedate : '',
      indate: new Date().toISOString(),
      reference: values.reference !== undefined ? values.reference : '',
      amount: values.amount !== undefined ? values.amount : '',
      type: parseInt(values.type),
      comment: values.comment !== undefined ? values.comment : '',
      person: address.dataset.id ? `Contact/${address.dataset.id}` : ''
    }

    let invalid = false;
    let dateInvalid = false
    const Must = ['date', 'duedate', 'amount']
    for (let item of Must) {
      if (dateInvalid && item === 'duedate') { continue }
      if (postData[item] === '') {
        if (item === 'date') { dateInvalid = true }
        Admin.setFormInputInvalid(document.getElementById('bill'), item, 'Valeur nécessaire')
        invalid = true
      } else {
        switch (item) {
          case 'amount':
            if (isNaN(parseFloat(postData[item]))) {
              invalid = true
              Admin.setFormInputInvalid(document.getElementById('bill'), item, 'Valeur invalide')
            }
            break
          case 'date':
          case 'duedate':
            if (isNaN(new Date(postData[item]).getTime())) {
              if (item === 'date') {
                dateInvalid = true
              }
              invalid = true
              Admin.setFormInputInvalid(document.getElementById('bill'), item, 'Valeur invalide')
            }
            break
        }
      }
    }
    if (invalid) { return }

    fetch(new URL('../Facture', window.location), {
        method: 'POST', 
        body: JSON.stringify(postData),
        header: new Headers({'X-Request-Id':`${new Date().getTime()}-${performance.now()}`})
      }).then(response => {
      if (response.ok) {
        response.json().then(async function (result) {
          if (result.length === 1 && result.data[0].id) {
            const FactureID = result.data[0].id
            for (let i in values.repartition) {
              let rep = values.repartition[i]
              let postData = {
                facture: FactureID,
                project: rep.project,
                value: rep.ht,
                tva: rep.tvapc // valeur en pourcent de la TVA
              }
              let response = await fetch(new URL('../Repartition', window.location), {
                  method: 'POST', 
                  body: JSON.stringify(postData),
                  header: new Headers({'X-Request-Id':`${new Date().getTime()}-${performance.now()}`})
              })
              if (response.ok) {
                let data = await response.json()
              }
            }
            window.Facture.clearRepartition()
            let links = document.getElementById('link-target')
            let link = links.firstElementChild
            while(link) {
              if (link.dataset.linkId && link.dataset.linkType) {
                let respone = await fetch(new URL('../FactureLien', window.location), {
                  method: 'POST',
                  body: JSON.stringify({
                    source: parseInt(FactureID),
                    destination: parseInt(link.dataset.linkId),
                    type: parseInt(link.dataset.linkType)
                  }),
                  header: new Headers({'X-Request-Id':`${new Date().getTime()}-${performance.now()}`})
                })
                let current = link
                window.requestAnimationFrame(() => current.parentNode.removeChild(current))
              }
              link = link.nextElementSibling
            }
            facture.queryOne(result.data[0].id)
            Admin.clearForm('bill')
          }
        })
      }
    })
  })
</script>
</html>
