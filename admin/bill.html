<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" type="text/css" href="css/admin.css" />
  <link rel="stylesheet" type="text/css" href="css/codebox.css" />
  <link rel="stylesheet" type="text/css" href="css/dtable.css" />
  <link rel="stylesheet" href="../node_modules/@fortawesome/fontawesome-free/css/all.min.css" type="text/css" />
  <style type="text/css">
    .client.alt_0 {
      color: darkblue;
    }
    .client {
      max-width: 32ch !important;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .reference {
      max-width: 12ch !important;
      overflow: hidden;;
      text-overflow:  ellipsis;
    }
    .center {
      text-align: center;
    }
  </style>
<title>Horaire</title>
<link href="https://fonts.googleapis.com/css?family=Passion+One" rel="stylesheet">
</head>
<body>
  <h2>Ajout facture</h2>
  <form id="bill">
    <fieldset id="address">
      <legend>Adresse</legend>
    </fieldset>
    <fieldset id="detail">
      <legend>Détail facture</legend>
      <label>Type </label> <select name="type">
        <option value="2">Facture débiteur</option>
        <option value="1">Facture créancier</option>
        <option value="3">Note de crédit</option>
        <option value="4">Compensation</option>
      </select></label>
      <label>N° de facture <input type="text" name="reference" /></label>
      <label>Date <input type="text" name="date" /></label>
      <label>Délai <input type="text" name="duedate" value="30" data-default="30" /></label><br />
      <label>Montant (TVA incluse) <input type="text" name="amount" /></label>
      <label>Monnaie <select name="currency">
        <option value="chf" selected>CHF</option>
        <option value="eur">EUR [€]</option>
        <option value="usd">USD [$]</option>
        <option value="gbp">GBP [£]</option>
        <option value="jpy">JPY [¥]</option>
      </select></label><br />
      <label>Remarque <input type="text" name="comment" style="width: 120ch;"/></label>
    </fieldset>
    <fieldset id="link-target" class="link results">
      <legend>Lier à</legend>
      <input type="button" value="Lier ..." onclick="linkTo()"/>
    </fieldset>
    <fieldset data-type="repartition">
      <legend>Répartition du montant</legend>
      <div class="note">
        Les montants indiqués en valeur absolue sont hors TVA. Les montants exprimés en pourcent inlcuent la TVA.
      </div>
      <div data-type="repartitionFrag">
      <label>Projet <input type="text" name="project" tabindex></label>
      <label>Montant <input type="text" name="value" tabindex></label>
      <label>TVA <input name="tva" type="text" data-default="7.7" tabindex value="7.7"></label>
      </div>
    </fieldset>
    <input type="submit" value="Ajouter" />
  </form>
  <h2>Factures enregistrées</h2>
  <div style="font-weight: bold; font-size: 16pt;"><a href="exec/export/bill.php" target="_blank">Exportation pour paiment</a></div>
  <div><form method="POST" onsubmit="doImport(event)" action="exec/import/bill.php" enctype="multipart/form-data"><input type="file" name="gfimport"><input type="submit" value="Reimportation"></form></div>
  <div style="font-weight: bold; font-size: 16pt;"><a href="exec/export/bill.php?paid=1" target="_blank">Exportation facture payée</a></div>
  <br>
  <label><input type="radio" onchange="factureCre()" checked="checked"  name="type"> Créancier</label>
  <label><input type="radio" onchange="factureDeb()" name="type"> Débiteur</label>
  <label><input type="radio" onchange="factureAll2()" name="type"> Toute</label>
  <br>
  <label><input type="radio" onchange="factureUnpaid()" checked="checked"  name="state"> Ouverte</label>
  <label><input type="radio" onchange="facturePaid()" name="state"> Payée</label>
  <label><input type="radio" onchange="factureAll()" name="state"> Toute</label>
  <!---<table id="facture" data-source="Facture" data-options="{}" data-entry-id="id">
    <thead class="darkbg"><tr>
      <th data-attribute="indate:date">Date d'entrée</th>
      <th data-attribute="date:date">Date de facture</th>
      <th data-attribute="duedate:date">Payable</th>
      <th data-class="reference" data-attribute="reference">N° de facture</th>
      <th data-class="client" data-attribute="@../$person displayname|person">Adresse</th>
      <th data-attribute="amount:money" data-sort-type="money">Montant</th>
      <th data-attribute="currency">Devise</th>
      <th data-class="center" data-sort-name="type" data-attribute="type~2=Facture débiteur,1=Facture créancier,3=Note de crédit,4=Compensation" data-sort-type="int">Type</th>
      <th data-class="center" data-sort-name="payee" data-attribute="paid~0=non,1=oui">Payée</th>
      <th data-class="center" data-attribute="rappel" data-sort-type="int" data-sort-name="rappel">Nbre de rappels</th>
      <th data-class="center" data-attribute="paiement" data-sort-type="int">Nbre paiements</th>
      <th data-class="center clickable" data-attribute="repartition" data-sort-type="int">Répartitions</th>
    </tr></thead>
    <tbody>
    </tbody>
  </table>//-->
</body>
<script src="../conf/kaal.js"></script>
<script src="js/lib/login.js"></script>
<script src="js/kaal.js"></script>
<script src="js/fetch.js"></script>
<script type="module" src="js/bill.js"></script>
<script src="../node_modules/sjcl/sjcl.js"></script>
<script src="../node_modules/popper.js/dist/umd/popper.min.js"></script>
<script src="../node_modules/transliteration/dist/browser/bundle.umd.min.js"></script>
<script src="../node_modules/artnum/String.js"></script>
<script src="../node_modules/artnum/Path.js"></script>
<script src="../node_modules/artnum/Select.js"></script>
<script src="../node_modules/artnum/Query.js"></script>
<script src="../node_modules/artnum/Date.js"></script>
<script src="/js/DTable.js"></script>
<script src="js/admin.js"></script>
<script src="js/stores.js"></script>
<script type="module">
  import {Address} from './js/address.js'
  const address = new Address(document.getElementById('address'))
</script>
<script>
  function doImport(event) {
    let resDiv = Admin.popup('', 'Importation', {closable: true, supClasses: ['import']})
    event.preventDefault();
    let fd = new FormData(event.target)
    fetch(new URL(`${KAAL.getBase()}/admin/exec/import/bill.php`), {method: 'POST', body: fd}).then(response => {
      if (!response.ok) {
        KAAL.error('Erreur d\'envoi du fichier')
      } else {
        response.json().then(result => {
            resDiv.innerHTML = '<div>Importation effectuée ...</div>'
            for (let i in result) {
              let op = result[i]
              if (op.type === 'none') { continue; } // nothing done
              let opname = ''
              switch (op.op) {
                case 'update': opname = 'Mise à jour'; break
                case 'add': opname = 'Ajout'; break
                case 'delete': opname = 'Suppression'; break
              }
              let d = document.createElement('DIV')
              switch (op.type) {
                case 'facture':
                  d.innerHTML = `Facture ${op.reference}`
                  if (!op.options) {
                    d.innerHTML += ` ${op.success ? 'ok' : 'échec'}`
                  } else {
                    if (op.options.client) {
                      d.innerHTML += ` ${op.success ? 'ok' : 'échec'}, client trouvé pour "${op.options.original}"`
                    } else {
                      if (op.options.proximity.length <= 0) {
                        d.innerHTML += ` ${op.success ? 'ok' : 'échec'}, aucun client trouvé pour "${op.options.original}"`
                      } else {
                        d.dataset.addMe = true
                        d.innerHTML += ` ${op.success ? 'ok' : 'échec'}, choisir client pour "${op.options.original}"`
                        let ul = document.createElement('ul')
                        ul.dataset.id = op.id
                        let i = 0                   
                        for (let k in op.options.proximity) {
                          let e = op.options.proximity[k]
                          let li = document.createElement('LI')
                          li.innerHTML = `<a href="#">${e[0]}</a>`
                          li.dataset.id = k
                          ul.appendChild(li)
                          if (i === 10) {
                            let li = document.createElement('LI')
                            li.innerHTML = ' ... plus .... '
                            ul.appendChild(li)
                            li.addEventListener('click', event => {
                              let n = event.target
                              event.stopPropagation()
                              event.preventDefault()
                              let i = n.nextElementSibling
                              n.parentNode.removeChild(n)
                              while (i) {
                                i.classList.remove('more')
                                i = i.nextElementSibling
                              }
                            })
                          } else {
                            li.addEventListener('click', (event) => {
                              let li = event.target
                              while (li && li.nodeName !== 'LI') { li = li.parentNode }
                              if (!li) { return }
                              let ul = li
                              while (ul && ul.nodeName !== 'UL') { ul = ul.parentNode }
                              if (!ul) { return }
                              ul.classList.add('inprogress')
                              fetch(new URL(`${KAAL.getBase()}/Facture/${ul.dataset.id}`), {method: 'PATCH', body: JSON.stringify({
                                id: ul.dataset.id,
                                person: li.dataset.id
                              })}).then(response => {
                                if (response.ok) {
                                  ul.parentNode.removeChild(ul)
                                }
                              })
                            })
                          }
                          if (i > 10) { 
                            li.classList.add('more')
                          }
                          i++
                        }
                        d.appendChild(ul)
                      }
                    }
                  }
                
                  break
                case 'repartition':                  
                  d.innerHTML = `Répartition ${opname} ${op.success ? 'ok' : op.msg} `
                  break
              }
              if (d.dataset.addMe) {
                 resDiv.appendChild(d)
              }
            }
        })
      }
    })
  }
  function SearchBill (param, term) {
    return new Promise((resovle, reject) => {
      let url = new URL('../Facture', window.location)
      switch (param) {
        case 'reference':
          url.searchParams.append('search.reference', `~${term.trim()}%`)
          break
        case 'amount':
          url.searchParams.append('search.amount', `${term.trim()}`)
          break
        case 'date':
          let date = Date.EUParse(term)
          if (!isNaN(date.getTime())) {
            url.searchParams.append('search.date', `~${date.toISOString()}`)
          } else {
            return
          }
          break
      }
      fetch(url).then(response => {
        if (response.ok) {
          response.json().then(results => {
            if (results.length > 0) {
              if (!Array.isArray(results.data)) {
                results.data = [results.data]
              }
            } else {
              results.data = []
            }
            resovle(results.data)
          })
        } else {
          reject(new Error('Pas de résultats'))
        }
      }, reason => reject(reason))
    })
  } 

  function extendBill () {

  }

  function delBill(id, dtable) {
    if (!id) {
      return
    }
    
    fetch(new URL(`../Facture/${id}`, window.location), {
      method: 'DELETE'
    }).then(response => {
      if (!response.ok) {
        return
      }
      response.json().then(result => {
        if (result.length === 1) {
          if (result.data[0][id]) {
            dtable.queryOne(id)
          }
        }
      })
    })
  }

  function addRappelSimple (factureId, dtable) {
    let kaal = KAAL.transaction('Ajout d\'un rappel')
    const fakeFacture = {
      reference: `${factureId}-${(new Date()).getTime()}`,
      amount: 0.0,
      date: new Date().toISOString(),
      indate: new Date().toISOString(),
      duedate: new Date()

    }

    fakeFacture.duedate.setTime(new Date().getTime() + 30 * 864000)
    fakeFacture.duedate = fakeFacture.duedate.toISOString()
    
    fetch(new URL(`Facture/${factureId}`, KAAL.getBase())).then(response => {
      if (!response.ok) { kaal.error('Facture inexistante'); return }
      response.json().then(result => {
        if (result.length <= 0) { kaal.error('Facture inexistante'); return }
        let f = Object.assign(Array.isArray(result.data) ? result.data[0] : result.data, fakeFacture)
        delete f.id
        delete f.repartition
        delete f.paiement
        delete f.paid
        delete f.deleted
        delete f.rappel
        fetch(new URL('Facture', KAAL.getBase()), {
          method: 'POST',
          body: JSON.stringify(f)
        }).then(response => {
          if (!response.ok) { kaal.error('Ajout du rappel échoué'); return }
          response.json().then(result => {
            if (result.length <= 0) { kaal.error('Ajout du rappel échouché'); return}
            let rappelId = result.data[0].id
            fetch(new URL('FactureLien', KAAL.getBase()), {
              method: 'POST',
              body: JSON.stringify({
                source: factureId,
                destination: rappelId,
                type: 2
              })
            }).then(response => {
              if (!response.ok) { kaal.error('Ajout du rappel échouché'); return }
              response.json().then(result => {
                dtable.queryOne(factureId)
                kaal.info('Rappel ajouté')
              })
            })
          })
        })
      })
    })
  }

  function openRepartition (factureId, dtable) {
    let popup = Admin.popup('', 'Répartition ', {closable: true, classes: ['repartition']})
    let url = new URL('../Repartition', window.location)
    url.searchParams.append('search.facture', factureId)
    
    let delRepartition = function (node, repartition, project) {
      fetch(new URL(`../Repartition/${repartition.id}`, window.location), {method: 'DELETE'}).then(response => {
        if (!response.ok) { return }
        response.json().then(result => {
          if (result.length === 1) {
            if (result.data[0][repartition.id]) {
              while (node && node.nodeName !== 'P') { node = node.parentNode }
              window.requestAnimationFrame(() => node.parentNode.removeChild(node))
              dtable.queryOne(factureId)
            }
          }
        })
      })
    }

    window.requestAnimationFrame(() => {
      popup.innerHTML = `<p class="header"><span class="field projectReference">Projet</span>
        <span class="field repartitionValue">Montant</span>
        <span class="field repartitionTVA">TVA</span>`
    })
    let frag = document.createDocumentFragment()
    fetch(url).then(response => {
      if (!response.ok) { return }
      response.json().then(result => {
        let loadRepartition = []
        for (let i = 0; i < result.length; i++) {
          let rep = result.data[i]
          loadRepartition.push(new Promise((resolve, reject) => {
            fetch(new URL(`../Project/${rep.project}`, window.location)).then(response => {
              if (!response.ok) { return }
              response.json().then(result => {
                let project = result.data
                let p = document.createElement('P')
                if (result.length > 0) {
                  p.innerHTML = `<span class="field projectReference">${result.data.reference}</span>
                  <span class="field repartitionValue">${parseFloat(rep.value).toFixed(2)}</span>
                  <span class="field repartitionTVA">${parseFloat(rep.tva).toFixed(2)}</span>
                  <i data-action="delete" class="far fa-trash-alt"></i>`
                } else {
                  p.innerHTML = `<span class="field projectReference">Projet inconnu</span>
                  <span class="field repartitionValue">${parseFloat(rep.value).toFixed(2)}</span>
                  <span class="field repartitionTVA">${parseFloat(rep.tva).toFixed(2)}</span>
                  <i data-action="delete" class="far fa-trash-alt"></i>`
                }
                p.addEventListener('click', event => {
                  if (!event.target.dataset || !event.target.dataset.action) { return }
                  switch (event.target.dataset.action) {
                    case 'delete': return delRepartition(event.target, rep, project)
                  }
                })
                frag.appendChild(p)
                resolve()
              }, reason => resolve())  
            }, reason => resolve())
          }))
        }
        Promise.all(loadRepartition).then(() => {
          let form = document.createElement('FORM')
          form.innerHTML = `Projet : <input type="text" name="project"><br>
                            Montant (TTC): <input type="text" name="amount"><br>
                            TVA : <input type="text" name="TVA" value="7.7"><br>
                            <input type="submit" value="Ajouter" />
                            `
          let inputs = form.getElementsByTagName('INPUT')
          for (let i = 0; i < inputs.length; i++) {
            if (inputs[i].name === 'project') {
              Select(inputs[i], new STProject('Project'), {realSelect: true, allowFreeText: false})
            }
          }
          form.addEventListener('submit', event => {
            event.preventDefault()
            let form = Admin.getForm(event.target)
            form.TVA = parseFloat(form.TVA)
            form.amount = parseFloat(form.amount)
            form.project = parseInt(form.project)
            if (isNaN(form.TVA) || isNaN(form.amount) || isNaN(form.project)) {
              return
            }

            /* nous voulons du hors-taxe */
            form.amount = form.amount / (1 + form.TVA / 100)
            let body = {value: form.amount, tva: form.TVA, project: form.project, facture: factureId}
            fetch(new URL('../Repartition', window.location), {
              method: 'POST',
              body: JSON.stringify(body)
            }).then(response=> {
              if (!response.ok) { return }
              response.json().then(result => {
                if (result.length > 0) {
                  let getProject = new Promise ((resolve, reject) => {
                    fetch(`../Project/${form.project}`).then (response => {
                      if (!response.ok) {
                        resolve({reference: ''})
                      }
                      response.json().then(result => {
                        if (result.length <= 0) { resolve ({reference: ''}) }
                        if (Array.isArray(result.data)) {
                          resolve(result.data[0])
                        } else {
                          resolve(result.data)
                        }
                      })
                    })
                  })

                  getProject.then(project => {
                    let p = document.createElement('P')
                    p.innerHTML = `<span class="field projectReference">${project.reference}</span>
                    <span class="field repartitionValue">${parseFloat(form.amount).toFixed(2)}</span>
                    <span class="field repartitionTVA">${parseFloat(form.TVA).toFixed(2)}</span>
                    <i data-action="delete" class="far fa-trash-alt"></i>`
                    body.id = result.data[0].id
                    p.addEventListener('click', event => {
                      if (!event.target.dataset || !event.target.dataset.action) { return }
                      switch (event.target.dataset.action) {
                        case 'delete': return delRepartition(event.target, body, project)
                      }
                    })
                    window.requestAnimationFrame(() => popup.insertBefore(p, event.target))
                    dtable.queryOne(factureId)
                  })
                }
              })
            })
          })
          frag.appendChild(form)
          window.requestAnimationFrame(() => popup.appendChild(frag))
        })
      })
    })
  }

  function addPaiement (id, dtable) {
    let popup = Admin.popup('', 'Paiements', {closable: true, minWidth: '40%', classes: ['paiementListe']})
    const innerForm = `Date : <input type="text" name="date" value="${(new Date()).fullDate()}"><br>
                        Montant : <input type="text" name="amount" value=""> (vide si paiement total)<br>
                      <input type="submit" value="Ajout paiement" /> <input type="submit" name="add-quit" value="Ajout paiement et quitter" />`
    const subForm = function (form, facture) {
      let values = Admin.getForm(form)
      if (values.date !== null) {
        let amount = values.amount === null ? parseFloat(facture.amount) : parseFloat(values.amount)
        let date = Date.EUParse(values.date)
        if (isNaN(date.getTime()) || isNaN(amount)) {
          return
        }
        fetch(new URL('../Paiement', window.location), {
          method: 'POST',
          body: JSON.stringify({ facture: facture.id, amount: amount, date: date.toISOString() }),
        }).then(response => {
          if (!response.ok) { return }
          response.json().then(result => {
            if (result.length > 0) {
              let node = document.createElement('DIV')
              node.dataset.paiementId = result.data[0].id
              node.innerHTML = `${date.fullDate()} - ${parseFloat(amount).toFixed(2)}  <span style="float: right"><i class="far fa-trash-alt"></i></span>`
              popup.insertBefore(node, popup.firstElementChild)
              dtable.queryOne(facture.id)
            }
          })
        })
      }
      return values
    }

    const delPaiement = function (node, paiement, facture) {
      while (node && !node.dataset.paiementId) { node = node.parentNode }
      if (!node) { return }
      fetch(new URL(`../Paiement/${paiement.id}`, window.location), {method: 'DELETE'}).then (response => {
        if (!response.ok) { return }
        response.json().then(result => {
          if (result.length === 1) {
            if (result.data[0][paiement.id]) {
              window.requestAnimationFrame(() => node.parentNode.removeChild(node))
              dtable.queryOne(facture.id)
              let form = document.createElement('FORM')
            }
          }
        })
      })
    }

    let url = new URL('../Paiement', window.location)
    url.searchParams.append('search.facture', id)
    let p = fetch(url)
    let f = fetch(new URL(`../Facture/${id}`, window.location))
    Promise.all([p, f]).then(([response1, response2]) => {
      if (!response1.ok || !response2) { return }
      Promise.all([response1.json(), response2.json()]).then(([result1, result2]) => {
        let totalPaid = 0
        let frag = document.createDocumentFragment()
        if (result2.length !== 1) { return }
        let facture = result2.data

        if (result1.length > 0) {
          for (let i = 0; i < result1.length; i++) {
            let paiement = result1.data[i]
            let node = document.createElement('DIV')
            node.dataset.paiementId = paiement.id
            totalPaid = parseFloat(paiement.amount)
            node.classList.add('paiement')
            node.innerHTML = `${(new Date(paiement.date)).fullDate()} - ${parseFloat(paiement.amount).toFixed(2)} <span style="float: right"><i data-action="delete" class="far fa-trash-alt"></i></span>`
            node.addEventListener('click', event => {
              if (!event.target.dataset || !event.target.dataset.action) { return }
              switch (event.target.dataset.action) {
                case 'delete': return delPaiement(event.target, paiement, facture)
              }
            })
            frag.appendChild(node)
          }
        }

        let form = document.createElement('FORM')
        form.innerHTML = innerForm
        frag.appendChild(form)
        form.addEventListener('submit', event => {
          event.preventDefault()
          let values = subForm(event.target, facture)
          if (values['add-quit']) {
            popup.close()
          }
        })

        popup.appendChild(frag)
      })
    })
  } 

  const actions = [
    {
      html: '<button type="button">Paiement</button>',
      events: [
        {name: 'click', callback: (event, dtable) => addPaiement(event.target.dataset.id, dtable)}
      ]
    },
    {
      html: '<button type="button">Répartition</button>',
      events: [
        {name: 'click', callback: (event, dtable) => openRepartition(event.target.dataset.id, dtable)}
      ]
    },
    {
      html: '<button type="button">Ajout rappel</button>',
      events: [
        //{name: 'click', callback: (event, dtable) => addRappelSimple(event.target.dataset.id, dtable)}
        {name: 'click', callback: (event, dtable) => {}}
      ]
    },
    {
      html: '<button type="button">Supprimer</button>',
      events: [
        {name: 'click', callback: (event, dtable) => delBill(event.target.dataset.id, dtable) }
      ]
    }
  ]
  /*const facture = new Artnum.DTable({table: document.getElementById('facture'), actions: actions})
  facture.transliterate = transliterate

  facture.postprocess = (tr) => {
    for (let td = tr.firstElementChild; td; td = td.nextElementSibling) {
      if (td.dataset.sortName === 'rappel') {
        if (parseInt(td.dataset.sortValue) > 0) {
          tr.classList.add('late')
          return
        }
      }
    }
  }

  function facturePaid () {
    facture.setFilter('payee', 'oui')
  }

  function factureUnpaid() {
    facture.setFilter('payee', 'non')
  }

  function factureAll() {
    facture.clearFilter('payee')
  }

  function factureCre() {
    facture.setFilter('type', 'créancier')
  }

  function factureDeb() {
    facture.setFilter('type', 'débiteur')
  }
  function factureAll2() {
    facture.clearFilter('type')
  }

  factureUnpaid()
  factureCre()*/

  function linkTo () {
    Admin.fetchPopup('html_frag/linkbill.html', 'Lier facture', { closable: true, minWidth: '40%' }).then(popup => {
      popup.addEventListener('submit', event => {
        event.preventDefault()
        switch (event.target.getAttribute('name')) {
          case 'searchBill':
            let search = Admin.getForm(event.target)
            if (search.terms && search.searchby) {
              let queries = []
              queries.push(SearchBill(search.searchby, search.terms))
              Promise.all(queries).then(results => {
                let outRes = []
                results.forEach(result => {
                  if (Array.isArray(result) && result.length > 0) {
                    outRes = [...outRes, ...result]
                  }
                })
                let addrs = []
                let Addresses = {}
                outRes.forEach(bill => {
                  if (bill.person === '') { return }
                  if (Addresses[bill.person] === undefined) {
                    addrs.push(new Promise((resolve, reject) => {
                      fetch(`../${bill.person}`, window.location).then(response => {
                        if (response.ok) {
                          response.json().then(result => {
                            if (result.length > 0) {
                              if (Array.isArray(result.data)) {
                                result.data = result.data[0]
                              }
                              resolve(result.data)
                            } else {
                              //reject(new Error('Contact introuvable'))
                            }
                          }, reason => reject(reason))
                        } else {  
                          //reject(new Error('Contact introuvable'))
                        }
                      }, reason => reject(reason))
                    }))
                    Addresses[bill.person] = addrs.length - 1
                  }
                })
                let ids = []
                let divs = event.target.getElementsByTagName('DIV')
                let resultDiv
                for (let div of divs) {
                  if (div.getAttribute('name') === 'link-results') {
                    resultDiv = div
                    break
                  }
                }
                if (addrs.length === 0) {
                  let node = resultDiv.firstElementChild
                  while (node) {
                    let current = node
                    node = node.nextElementSibling
                    if (current.dataset.static) { continue }
                    if (ids.indexOf(current.id) === -1) {
                    window.requestAnimationFrame(() => current.parentNode.removeChild(current))
                    }
                  }
                  return
                }
                Promise.all(addrs).then(addrs => {
                  for (let i in outRes) {
                    let person = outRes[i].person
                    if (Addresses[person] !== undefined) {
                      outRes[i].person = addrs[Addresses[person]]
                    }
                  }

                  outRes.forEach (bill => {
                    let d = document.createElement('DIV')
                    d.id = `link-result-${bill.id}`
                    ids.push(d.id)
                    let adresse = ''
                    if (bill.person && bill.person.displayname) {
                      adresse = bill.person.displayname
                    }
                    d.innerHTML = `<span class="reference">${bill.reference}</span><span class="amount">${Admin.formatMoney(bill.amount, bill.currency)}</span><span class="date">${new Date(bill.date).fullDate()}</span><span class="address">${adresse}</span>`
                    if (document.getElementById(d.id)) {
                      window.requestAnimationFrame(() => resultDiv.replaceChild(d, document.getElementById(d.id)))
                    } else {
                      window.requestAnimationFrame(() => resultDiv.appendChild(d))
                    }
                    d.addEventListener('click', (event) => {
                      let node = event.target
                      while (node && node.nodeName !== 'DIV') { node = node.parentNode }
                      window.requestAnimationFrame(() => node.classList.add('selected'))
                      for(let other = node.parentNode.firstElementChild; other; other = other.nextElementSibling) {
                        if (other.id !== node.id && other.classList.contains('selected')) {
                          window.requestAnimationFrame(() => other.classList.remove('selected'))
                        }
                      }
                    })
                  })
                
                 let node = resultDiv.firstElementChild
                  while (node) {
                    let current = node
                    node = node.nextElementSibling
                    if (current.dataset.static) { continue }
                    if (ids.indexOf(current.id) === -1) {
                    window.requestAnimationFrame(() => current.parentNode.removeChild(current))
                    }
                  }
                })
              })
            }
            break
          case 'Link':
            let link = Admin.getForm(event.target)
            let popup = event.target.parentNode
            while (popup && popup.nodeName !== 'DIV') { popup = popup.parentNode }
            let selectedDiv = popup.querySelector('form[name="searchBill"] div[name="link-results"] div.selected')
            if (selectedDiv) {
              let div = selectedDiv.cloneNode(selectedDiv)
              div.dataset.linkType = link.type
              div.dataset.linkId = selectedDiv.id.split('-').pop()
              div.removeAttribute('id')
              let target = document.getElementById('link-target')
              let valid = true
              for (let link = target.firstElementChild; link; link = link.nextElementSibling) {
                if (link.dataset.linkId === div.dataset.linkId) {
                  valid = false;
                  break;
                }
              }
              let type = document.createElement('SPAN')
              type.classList.add('type')
              switch(div.dataset.linkType) {
                case '1': 
                  type.innerHTML = 'Note de crédite / Compensation'
                  break
                case '2': 
                  type.innerHTML = 'Rappel'
                  break
                case '3': 
                  type.innerHTML = 'Sommation'
                  break
                case '4': 
                  type.innerHTML = 'Poursuite'
                  break
              }
              div.insertBefore(type, div.firstElementChild)
              div.classList.remove('selected')
              if (valid) {
                window.requestAnimationFrame(() => target.appendChild(div))
              }
            }
            popup.dispatchEvent(new Event('close'))
            break
        }
      }, { capture: true })
      popup.addEventListener('reset', event => {
        event.preventDefault()
        popup.dispatchEvent(new Event('close'))
      }, { capture: true })
    })
  }

  let inputs = document.getElementsByTagName('INPUT')
  for (let i = 0; i < inputs.length; i++) {
    if (inputs[i].getAttribute('name') === 'project') {
      Select(inputs[i], new STProject('Project'), {realSelect: true, allowFreeText: false})
    }
  }

  let f = document.getElementById('bill').addEventListener('submit', event => {
    event.preventDefault()
    Admin.setFormInputInvalid(document.getElementById('bill'), '*', '', true)
    let values = window.Facture.getValues()
    let postData = {
      reference: values.reference !== undefined ? values.reference : '',
      currency: values.currency !== undefined ? values.currency : 'chf',
      date: values.date !== undefined ? values.date : '',
      duedate: values.duedate !== undefined ? values.duedate : '',
      indate: new Date().toISOString(),
      reference: values.reference !== undefined ? values.reference : '',
      amount: values.amount !== undefined ? values.amount : '',
      type: parseInt(values.type),
      comment: values.comment !== undefined ? values.comment : '',
      person: address.dataset.id ? `Contact/${address.dataset.id}` : ''
    }

    let invalid = false;
    let dateInvalid = false
    const Must = ['date', 'duedate', 'amount']
    for (let item of Must) {
      if (dateInvalid && item === 'duedate') { continue }
      if (postData[item] === '') {
        if (item === 'date') { dateInvalid = true }
        Admin.setFormInputInvalid(document.getElementById('bill'), item, 'Valeur nécessaire')
        invalid = true
      } else {
        switch (item) {
          case 'amount':
            if (isNaN(parseFloat(postData[item]))) {
              invalid = true
              Admin.setFormInputInvalid(document.getElementById('bill'), item, 'Valeur invalide')
            }
            break
          case 'date':
          case 'duedate':
            if (isNaN(new Date(postData[item]).getTime())) {
              if (item === 'date') {
                dateInvalid = true
              }
              invalid = true
              Admin.setFormInputInvalid(document.getElementById('bill'), item, 'Valeur invalide')
            }
            break
        }
      }
    }
    if (invalid) { return }

    fetch(new URL('../Facture', window.location), {
        method: 'POST', 
        body: JSON.stringify(postData)
      }).then(response => {
      if (response.ok) {
        response.json().then(async function (result) {
          if (result.length === 1 && result.data[0].id) {
            const FactureID = result.data[0].id
            for (let i in values.repartition) {
              let rep = values.repartition[i]
              let postData = {
                facture: FactureID,
                project: rep.project,
                value: rep.ht,
                tva: rep.tvapc // valeur en pourcent de la TVA
              }
              let response = await fetch(new URL('../Repartition', window.location), {
                  method: 'POST', 
                  body: JSON.stringify(postData),
                  header: new Headers({'X-Request-Id':`${new Date().getTime()}-${performance.now()}`})
              })
              if (response.ok) {
                let data = await response.json()
              }
            }
            window.Facture.clearRepartition()
            let links = document.getElementById('link-target')
            let link = links.firstElementChild
            while(link) {
              if (link.dataset.linkId && link.dataset.linkType) {
                let respone = await fetch(new URL('../FactureLien', window.location), {
                  method: 'POST',
                  body: JSON.stringify({
                    source: parseInt(FactureID),
                    destination: parseInt(link.dataset.linkId),
                    type: parseInt(link.dataset.linkType)
                  }),
                  header: new Headers({'X-Request-Id':`${new Date().getTime()}-${performance.now()}`})
                })
                let current = link
                window.requestAnimationFrame(() => current.parentNode.removeChild(current))
              }
              link = link.nextElementSibling
            }
            facture.queryOne(result.data[0].id)
            Admin.clearForm('bill')
          }
        })
      }
    })
  })
</script>
</html>
