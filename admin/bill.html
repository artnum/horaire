<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" type="text/css" href="css/admin.css" />
  <link rel="stylesheet" type="text/css" href="css/codebox.css" />
  <link rel="stylesheet" type="text/css" href="css/dtable.css" />
  <style type="text/css">
    .client.alt_0 {
      color: darkblue;
    }
    .client {
      max-width: 32ch !important;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .reference {
      max-width: 12ch !important;
      overflow: hidden;;
      text-overflow:  ellipsis;
    }
    .center {
      text-align: center;
    }
  </style>
<title>Horaire</title>
<link href="https://fonts.googleapis.com/css?family=Passion+One" rel="stylesheet">
</head>
<body>
  <h2>Ajout facture</h2>
  <form id="bill">
    <fieldset id="address">
      <legend>Adresse</legend>
    </fieldset>
    <fieldset id="detail">
      <legend>Détail facture</legend>
      <label>Type </label> <select name="type">
        <option value="1">Facture débiteur</option>
        <option value="2">Facture créancier</option>
        <option value="3">Note de crédit</option>
        <option value="4">Compensation</option>
      </select></label>
      <label>N° de facture <input type="text" name="reference" /></label>
      <label>Date <input type="text" name="date" /></label>
      <label>Délai <input type="text" name="due" value="30" /></label><br />
      <label>Montant (TVA incluse) <input type="text" name="amount" /></label>
      <label>Monnaie <select name="currency">
        <option value="chf" selected>CHF</option>
        <option value="eur">EUR [€]</option>
        <option value="usd">USD [$]</option>
        <option value="gbp">GBP [£]</option>
        <option value="jpy">JPY [¥]</option>
      </select></label><br />
      <label>Remarque <input type="text" name="comment" style="width: 120ch;"/></label>
    </fieldset>
    <fieldset data-type="repartition">
      <legend>Répartition du montant</legend>
      <div class="note">
        Les montants indiqués en valeur absolue sont hors TVA. Les montants exprimés en pourcent inlcuent la TVA.
      </div>
      <div data-type="repartitionFrag">
      <label>Projet <input type="text" name="project" tabindex></label>
      <label>Montant <input type="text" name="value" tabindex></label>
      <label>TVA <input name="tva" type="text" data-default="7.7" tabindex value="7.7"></label>
      </div>
    </fieldset>
    <input type="submit" value="Ajouter" />
  </form>
  <h2>Factures enregistrées</h2>
  <table id="facture" data-source="Facture" data-options="{}" data-entry-id="id">
    <thead class="darkbg"><tr>
      <th data-attribute="indate:date">Date d'entrée</th>
      <th data-attribute="date:date">Date de facture</th>
      <th data-attribute="duedate:date">Date de paiement</th>
      <th data-class="reference" data-attribute="reference">Référence</th>
      <th data-attribute="amount:money" data-sort-type="money">Montant</th>
      <th data-class="client" data-attribute="@../$person displayname|person">Adresse</th>
      <th data-class="center" data-attribute="type~1=Facture débiteur,2=Facture créancier,3=Note de crédit,4=Compensation" data-sort-type="int">Type</th>
      <th data-class="center" data-attribute="paid~0=non,1=oui">Payée</th>
      <th data-class="center" data-attribute="paiement" data-sort-type="int">Nbre paiements</th>
      <th data-class="center" data-attribute="repartition" data-sort-type="int">Répartitions</th>
    </tr></thead>
    <tbody>
    </tbody>
  </table>
</body>
<script src="../conf/kaal.js"></script>
<script type="module" src="js/bill.js"></script>
<script src="../node_modules/sjcl/sjcl.js"></script>
<script src="../node_modules/popper.js/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/transliteration@2.1.3/dist/browser/bundle.umd.min.js"></script>
<script src="/js/String.js"></script>
<script src="/js/Path.js"></script>
<script src="/js/Select.js"></script>
<script src="/js/Query.js"></script>
<script src="/js/Date.js"></script>
<script src="/js/DTable.js"></script>
<script src="js/admin.js"></script>
<script src="js/stores.js"></script>
<script type="module">
  import {Address} from './js/address.js'
  const address = new Address(document.getElementById('address'))
</script>
<script>
  const facture = new Artnum.DTable({table: document.getElementById('facture')})
  facture.transliterate = transliterate
  facture.run()
  
  let inputs = document.getElementsByTagName('INPUT')
  for (let i = 0; i < inputs.length; i++) {
    if (inputs[i].getAttribute('name') === 'project') {
      Select(inputs[i], new STProject('Project'), {realSelect: true, allowFreeText: false})
    }
  }

  let f = document.getElementById('bill').addEventListener('submit', event => {
    event.preventDefault()
    let values = window.Facture.getValues()
    let postData = {
      reference: values.reference !== undefined ? values.reference : '',
      date: values.date !== undefined ? values.date : '',
      duedate: values.due !== undefined ? values.due : '',
      indate: new Date().toISOString(),
      reference: values.reference !== undefined ? values.reference : '',
      amount: values.amount !== undefined ? values.amount : 0,
      type: parseInt(values.type),
      comment: values.comment !== undefined ? values.comment : '',
      person: address.dataset.id ? `Contact/${address.dataset.id}` : ''
    }

    fetch(new URL('../Facture', window.location), {
        method: 'POST', 
        body: JSON.stringify(postData),
        header: new Headers({'X-Request-Id':`${new Date().getTime()}-${performance.now()}`})
      }).then(response => {
      if (response.ok) {
        response.json().then(async function (result) {
          if (result.length === 1 && result.data[0].id) {
            for (let i in values.repartition) {
              let rep = values.repartition[i]
              let postData = {
                facture: result.data[0].id,
                project: rep.project,
                value: rep.ht,
                tva: rep.tvapc // valeur en pourcent de la TVA
              }
              let response = await fetch(new URL('../Repartition', window.location), {
                  method: 'POST', 
                  body: JSON.stringify(postData),
                  header: new Headers({'X-Request-Id':`${new Date().getTime()}-${performance.now()}`})
              })
              if (response.ok) {
                let data = await response.json()
                if (data.length === 1) {
                  console.log(data)
                } else {
                  console.log(data)
                }
              }
            }
            facture.queryOne(result.data[0].id)
            Admin.clearForm('bill')
          }
        })
      }
    })
  })
</script>
</html>
